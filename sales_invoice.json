{
  "file_name": "sales_invoice.py",
  "file_path": "C:\\Users\\niles\\Desktop\\Code Analyzer\\sales_invoice.py",
  "language": "python",
  "code": "# Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n# License: GNU General Public License v3. See license.txt\n\n\nimport frappe\nimport frappe.utils\nfrom frappe import _, msgprint, throw\nfrom frappe.contacts.doctype.address.address import get_address_display\nfrom frappe.model.mapper import get_mapped_doc\nfrom frappe.model.utils import get_fetch_values\nfrom frappe.query_builder import Case\nfrom frappe.utils import add_days, cint, cstr, flt, formatdate, get_link_to_form, getdate, nowdate\nfrom frappe.utils.data import comma_and\n\nimport erpnext\nfrom erpnext.accounts.deferred_revenue import validate_service_stop_date\nfrom erpnext.accounts.doctype.loyalty_program.loyalty_program import (\n\tget_loyalty_program_details_with_points,\n\tvalidate_loyalty_points,\n)\nfrom erpnext.accounts.doctype.pricing_rule.utils import (\n\tupdate_coupon_code_count,\n\tvalidate_coupon_code,\n)\nfrom erpnext.accounts.doctype.repost_accounting_ledger.repost_accounting_ledger import (\n\tvalidate_docs_for_deferred_accounting,\n\tvalidate_docs_for_voucher_types,\n)\nfrom erpnext.accounts.doctype.tax_withholding_entry.tax_withholding_entry import SalesTaxWithholding\nfrom erpnext.accounts.general_ledger import get_round_off_account_and_cost_center\nfrom erpnext.accounts.party import get_due_date, get_party_account, get_party_details\nfrom erpnext.accounts.utils import (\n\tget_account_currency,\n\tupdate_voucher_outstanding,\n)\nfrom erpnext.assets.doctype.asset.asset import split_asset\nfrom erpnext.assets.doctype.asset.depreciation import (\n\tdepreciate_asset,\n\tget_gl_entries_on_asset_disposal,\n\tget_gl_entries_on_asset_regain,\n\treset_depreciation_schedule,\n\treverse_depreciation_entry_made_on_disposal,\n)\nfrom erpnext.assets.doctype.asset_activity.asset_activity import add_asset_activity\nfrom erpnext.controllers.accounts_controller import validate_account_head\nfrom erpnext.controllers.selling_controller import SellingController\nfrom erpnext.projects.doctype.timesheet.timesheet import get_projectwise_timesheet_data\nfrom erpnext.setup.doctype.company.company import update_company_current_month_sales\nfrom erpnext.stock.doctype.delivery_note.delivery_note import update_billed_amount_based_on_so\n\nform_grid_templates = {\"items\": \"templates/form_grid/item_grid.html\"}\n\n\nclass PartialPaymentValidationError(frappe.ValidationError):\n\tpass\n\n\nclass SalesInvoice(SellingController):\n\t# begin: auto-generated types\n\t# This code is auto-generated. Do not modify anything in this block.\n\n\tfrom typing import TYPE_CHECKING\n\n\tif TYPE_CHECKING:\n\t\tfrom frappe.types import DF\n\n\t\tfrom erpnext.accounts.doctype.item_wise_tax_detail.item_wise_tax_detail import ItemWiseTaxDetail\n\t\tfrom erpnext.accounts.doctype.payment_schedule.payment_schedule import PaymentSchedule\n\t\tfrom erpnext.accounts.doctype.pricing_rule_detail.pricing_rule_detail import PricingRuleDetail\n\t\tfrom erpnext.accounts.doctype.sales_invoice_advance.sales_invoice_advance import SalesInvoiceAdvance\n\t\tfrom erpnext.accounts.doctype.sales_invoice_item.sales_invoice_item import SalesInvoiceItem\n\t\tfrom erpnext.accounts.doctype.sales_invoice_payment.sales_invoice_payment import SalesInvoicePayment\n\t\tfrom erpnext.accounts.doctype.sales_invoice_timesheet.sales_invoice_timesheet import (\n\t\t\tSalesInvoiceTimesheet,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.sales_taxes_and_charges.sales_taxes_and_charges import (\n\t\t\tSalesTaxesandCharges,\n\t\t)\n\t\tfrom erpnext.accounts.doctype.tax_withholding_entry.tax_withholding_entry import TaxWithholdingEntry\n\t\tfrom erpnext.selling.doctype.sales_team.sales_team import SalesTeam\n\t\tfrom erpnext.stock.doctype.packed_item.packed_item import PackedItem\n\n\t\taccount_for_change_amount: DF.Link | None\n\t\tadditional_discount_account: DF.Link | None\n\t\tadditional_discount_percentage: DF.Float\n\t\taddress_display: DF.TextEditor | None\n\t\tadvances: DF.Table[SalesInvoiceAdvance]\n\t\tagainst_income_account: DF.SmallText | None\n\t\tallocate_advances_automatically: DF.Check\n\t\tamended_from: DF.Link | None\n\t\tamount_eligible_for_commission: DF.Currency\n\t\tapply_discount_on: DF.Literal[\"\", \"Grand Total\", \"Net Total\"]\n\t\tapply_tds: DF.Check\n\t\tauto_repeat: DF.Link | None\n\t\tbase_change_amount: DF.Currency\n\t\tbase_discount_amount: DF.Currency\n\t\tbase_grand_total: DF.Currency\n\t\tbase_in_words: DF.SmallText | None\n\t\tbase_net_total: DF.Currency\n\t\tbase_paid_amount: DF.Currency\n\t\tbase_rounded_total: DF.Currency\n\t\tbase_rounding_adjustment: DF.Currency\n\t\tbase_total: DF.Currency\n\t\tbase_total_taxes_and_charges: DF.Currency\n\t\tbase_write_off_amount: DF.Currency\n\t\tcash_bank_account: DF.Link | None\n\t\tchange_amount: DF.Currency\n\t\tcommission_rate: DF.Float\n\t\tcompany: DF.Link\n\t\tcompany_address: DF.Link | None\n\t\tcompany_address_display: DF.TextEditor | None\n\t\tcompany_contact_person: DF.Link | None\n\t\tcompany_tax_id: DF.Data | None\n\t\tcontact_display: DF.SmallText | None\n\t\tcontact_email: DF.Data | None\n\t\tcontact_mobile: DF.SmallText | None\n\t\tcontact_person: DF.Link | None\n\t\tconversion_rate: DF.Float\n\t\tcost_center: DF.Link | None\n\t\tcoupon_code: DF.Link | None\n\t\tcurrency: DF.Link\n\t\tcustomer: DF.Link | None\n\t\tcustomer_address: DF.Link | None\n\t\tcustomer_group: DF.Link | None\n\t\tcustomer_name: DF.SmallText | None\n\t\tdebit_to: DF.Link\n\t\tdisable_rounded_total: DF.Check\n\t\tdiscount_amount: DF.Currency\n\t\tdispatch_address: DF.TextEditor | None\n\t\tdispatch_address_name: DF.Link | None\n\t\tdont_create_loyalty_points: DF.Check\n\t\tdue_date: DF.Date | None\n\t\tfrom_date: DF.Date | None\n\t\tgrand_total: DF.Currency\n\t\tgroup_same_items: DF.Check\n\t\thas_subcontracted: DF.Check\n\t\tignore_default_payment_terms_template: DF.Check\n\t\tignore_pricing_rule: DF.Check\n\t\tignore_tax_withholding_threshold: DF.Check\n\t\tin_words: DF.SmallText | None\n\t\tincoterm: DF.Link | None\n\t\tinter_company_invoice_reference: DF.Link | None\n\t\tis_cash_or_non_trade_discount: DF.Check\n\t\tis_consolidated: DF.Check\n\t\tis_created_using_pos: DF.Check\n\t\tis_debit_note: DF.Check\n\t\tis_discounted: DF.Check\n\t\tis_internal_customer: DF.Check\n\t\tis_opening: DF.Literal[\"No\", \"Yes\"]\n\t\tis_pos: DF.Check\n\t\tis_return: DF.Check\n\t\titem_wise_tax_details: DF.Table[ItemWiseTaxDetail]\n\t\titems: DF.Table[SalesInvoiceItem]\n\t\tlanguage: DF.Link | None\n\t\tletter_head: DF.Link | None\n\t\tloyalty_amount: DF.Currency\n\t\tloyalty_points: DF.Int\n\t\tloyalty_program: DF.Link | None\n\t\tloyalty_redemption_account: DF.Link | None\n\t\tloyalty_redemption_cost_center: DF.Link | None\n\t\tnamed_place: DF.Data | None\n\t\tnaming_series: DF.Literal[\"ACC-SINV-.YYYY.-\", \"ACC-SINV-RET-.YYYY.-\"]\n\t\tnet_total: DF.Currency\n\t\tonly_include_allocated_payments: DF.Check\n\t\tother_charges_calculation: DF.TextEditor | None\n\t\toutstanding_amount: DF.Currency\n\t\toverride_tax_withholding_entries: DF.Check\n\t\tpacked_items: DF.Table[PackedItem]\n\t\tpaid_amount: DF.Currency\n\t\tparty_account_currency: DF.Link | None\n\t\tpayment_schedule: DF.Table[PaymentSchedule]\n\t\tpayment_terms_template: DF.Link | None\n\t\tpayments: DF.Table[SalesInvoicePayment]\n\t\tplc_conversion_rate: DF.Float\n\t\tpo_date: DF.Date | None\n\t\tpo_no: DF.Data | None\n\t\tpos_closing_entry: DF.Link | None\n\t\tpos_profile: DF.Link | None\n\t\tposting_date: DF.Date\n\t\tposting_time: DF.Time | None\n\t\tprice_list_currency: DF.Link\n\t\tpricing_rules: DF.Table[PricingRuleDetail]\n\t\tproject: DF.Link | None\n\t\tredeem_loyalty_points: DF.Check\n\t\tremarks: DF.SmallText | None\n\t\trepresents_company: DF.Link | None\n\t\treturn_against: DF.Link | None\n\t\trounded_total: DF.Currency\n\t\trounding_adjustment: DF.Currency\n\t\tsales_partner: DF.Link | None\n\t\tsales_team: DF.Table[SalesTeam]\n\t\tscan_barcode: DF.Data | None\n\t\tselect_print_heading: DF.Link | None\n\t\tselling_price_list: DF.Link\n\t\tset_posting_time: DF.Check\n\t\tset_target_warehouse: DF.Link | None\n\t\tset_warehouse: DF.Link | None\n\t\tshipping_address: DF.TextEditor | None\n\t\tshipping_address_name: DF.Link | None\n\t\tshipping_rule: DF.Link | None\n\t\tstatus: DF.Literal[\n\t\t\t\"\",\n\t\t\t\"Draft\",\n\t\t\t\"Return\",\n\t\t\t\"Credit Note Issued\",\n\t\t\t\"Submitted\",\n\t\t\t\"Paid\",\n\t\t\t\"Partly Paid\",\n\t\t\t\"Unpaid\",\n\t\t\t\"Unpaid and Discounted\",\n\t\t\t\"Partly Paid and Discounted\",\n\t\t\t\"Overdue and Discounted\",\n\t\t\t\"Overdue\",\n\t\t\t\"Cancelled\",\n\t\t\t\"Internal Transfer\",\n\t\t]\n\t\tsubscription: DF.Link | None\n\t\ttax_category: DF.Link | None\n\t\ttax_id: DF.Data | None\n\t\ttax_withholding_entries: DF.Table[TaxWithholdingEntry]\n\t\ttax_withholding_group: DF.Link | None\n\t\ttaxes: DF.Table[SalesTaxesandCharges]\n\t\ttaxes_and_charges: DF.Link | None\n\t\ttc_name: DF.Link | None\n\t\tterms: DF.TextEditor | None\n\t\tterritory: DF.Link | None\n\t\ttimesheets: DF.Table[SalesInvoiceTimesheet]\n\t\tto_date: DF.Date | None\n\t\ttotal: DF.Currency\n\t\ttotal_advance: DF.Currency\n\t\ttotal_billing_amount: DF.Currency\n\t\ttotal_billing_hours: DF.Float\n\t\ttotal_commission: DF.Currency\n\t\ttotal_net_weight: DF.Float\n\t\ttotal_qty: DF.Float\n\t\ttotal_taxes_and_charges: DF.Currency\n\t\tunrealized_profit_loss_account: DF.Link | None\n\t\tupdate_billed_amount_in_delivery_note: DF.Check\n\t\tupdate_billed_amount_in_sales_order: DF.Check\n\t\tupdate_outstanding_for_self: DF.Check\n\t\tupdate_stock: DF.Check\n\t\tuse_company_roundoff_cost_center: DF.Check\n\t\tutm_campaign: DF.Link | None\n\t\tutm_content: DF.Data | None\n\t\tutm_medium: DF.Link | None\n\t\tutm_source: DF.Link | None\n\t\twrite_off_account: DF.Link | None\n\t\twrite_off_amount: DF.Currency\n\t\twrite_off_cost_center: DF.Link | None\n\t\twrite_off_outstanding_amount_automatically: DF.Check\n\t# end: auto-generated types\n\n\tdef __init__(self, *args, **kwargs):\n\t\tsuper().__init__(*args, **kwargs)\n\t\tself.status_updater = [\n\t\t\t{\n\t\t\t\t\"source_dt\": \"Sales Invoice Item\",\n\t\t\t\t\"target_field\": \"billed_amt\",\n\t\t\t\t\"target_ref_field\": \"amount\",\n\t\t\t\t\"target_dt\": \"Sales Order Item\",\n\t\t\t\t\"join_field\": \"so_detail\",\n\t\t\t\t\"target_parent_dt\": \"Sales Order\",\n\t\t\t\t\"target_parent_field\": \"per_billed\",\n\t\t\t\t\"source_field\": \"amount\",\n\t\t\t\t\"percent_join_field\": \"sales_order\",\n\t\t\t\t\"status_field\": \"billing_status\",\n\t\t\t\t\"keyword\": \"Billed\",\n\t\t\t\t\"overflow_type\": \"billing\",\n\t\t\t}\n\t\t]\n\n\tdef set_indicator(self):\n\t\t\"\"\"Set indicator for portal\"\"\"\n\t\tif self.outstanding_amount < 0:\n\t\t\tself.indicator_title = _(\"Credit Note Issued\")\n\t\t\tself.indicator_color = \"gray\"\n\t\telif self.outstanding_amount > 0 and getdate(self.due_date) >= getdate(nowdate()):\n\t\t\tself.indicator_color = \"orange\"\n\t\t\tself.indicator_title = _(\"Unpaid\")\n\t\telif self.outstanding_amount > 0 and getdate(self.due_date) < getdate(nowdate()):\n\t\t\tself.indicator_color = \"red\"\n\t\t\tself.indicator_title = _(\"Overdue\")\n\t\telif cint(self.is_return) == 1:\n\t\t\tself.indicator_title = _(\"Return\")\n\t\t\tself.indicator_color = \"gray\"\n\t\telse:\n\t\t\tself.indicator_color = \"green\"\n\t\t\tself.indicator_title = _(\"Paid\")\n\n\tdef onload(self):\n\t\tsuper().onload()\n\t\tif self.customer:\n\t\t\ttax_withholding_category, tax_withholding_group = frappe.get_cached_value(\n\t\t\t\t\"Customer\", self.customer, [\"tax_withholding_category\", \"tax_withholding_group\"]\n\t\t\t)\n\t\t\tself.set_onload(\"apply_tds\", tax_withholding_category or tax_withholding_group)\n\n\tdef validate(self):\n\t\tself.validate_auto_set_posting_time()\n\t\tsuper().validate()\n\n\t\tself.is_subcontracted()\n\n\t\tif not (self.is_pos or self.is_debit_note):\n\t\t\tself.so_dn_required()\n\n\t\tSalesTaxWithholding(self).on_validate()\n\n\t\tself.validate_proj_cust()\n\t\tself.validate_pos_return()\n\t\tself.validate_with_previous_doc()\n\t\tself.validate_uom_is_integer(\"stock_uom\", \"stock_qty\")\n\t\tself.validate_uom_is_integer(\"uom\", \"qty\")\n\t\tself.check_sales_order_on_hold_or_close(\"sales_order\")\n\t\tself.validate_debit_to_acc()\n\t\tself.clear_unallocated_advances(\"Sales Invoice Advance\", \"advances\")\n\t\tself.validate_fixed_asset()\n\t\tself.set_income_account_for_fixed_assets()\n\t\tself.validate_item_cost_centers()\n\t\tself.check_conversion_rate()\n\t\tself.validate_accounts()\n\n\t\tvalidate_inter_company_party(\n\t\t\tself.doctype, self.customer, self.company, self.inter_company_invoice_reference\n\t\t)\n\n\t\t# Validating coupon code\n\t\tif self.coupon_code:\n\t\t\tvalidate_coupon_code(self.coupon_code)\n\n\t\tif cint(self.is_pos):\n\t\t\tself.validate_pos()\n\n\t\tif cint(self.is_created_using_pos):\n\t\t\tself.validate_created_using_pos()\n\t\t\tself.validate_full_payment()\n\n\t\tself.validate_dropship_item()\n\n\t\tif cint(self.update_stock):\n\t\t\tself.validate_warehouse()\n\t\t\tself.update_current_stock()\n\n\t\tself.validate_delivery_note()\n\n\t\tis_deferred_invoice = any(d.get(\"enable_deferred_revenue\") for d in self.get(\"items\"))\n\n\t\t# validate service stop date to lie in between start and end date\n\t\tif is_deferred_invoice:\n\t\t\tvalidate_service_stop_date(self)\n\n\t\tif not self.is_opening:\n\t\t\tself.is_opening = \"No\"\n\n\t\tself.set_against_income_account()\n\n\t\tif self.is_return and not self.return_against and self.timesheets:\n\t\t\tfrappe.throw(_(\"Direct return is not allowed for Timesheet.\"))\n\n\t\tif not self.is_return:\n\t\t\tself.validate_time_sheets_are_submitted()\n\n\t\tself.validate_multiple_billing(\"Delivery Note\", \"dn_detail\", \"amount\")\n\n\t\tif self.is_return and self.return_against:\n\t\t\tfor row in self.timesheets:\n\t\t\t\tif row.billing_hours:\n\t\t\t\t\trow.billing_hours = -abs(row.billing_hours)\n\t\t\t\tif row.billing_amount:\n\t\t\t\t\trow.billing_amount = -abs(row.billing_amount)\n\n\t\tself.update_packing_list()\n\t\tself.set_billing_hours_and_amount()\n\t\tself.update_timesheet_billing_for_project()\n\t\tself.set_status()\n\t\tif self.is_pos and not self.is_return:\n\t\t\tself.verify_payment_amount_is_positive()\n\n\t\t# validate amount in mode of payments for returned invoices for pos must be negative\n\t\tif self.is_pos and self.is_return:\n\t\t\tself.verify_payment_amount_is_negative()\n\n\t\tif self.redeem_loyalty_points and self.loyalty_points and not self.is_consolidated:\n\t\t\tvalidate_loyalty_points(self, self.loyalty_points)\n\n\t\tself.allow_write_off_only_on_pos()\n\t\tself.reset_default_field_value(\"set_warehouse\", \"items\", \"warehouse\")\n\t\tself.validate_subcontracted_sales_order()\n\t\tself.validate_scio_self_rm_qty()\n\n\tdef validate_accounts(self):\n\t\tself.validate_write_off_account()\n\t\tself.validate_account_for_change_amount()\n\t\tself.validate_income_account()\n\n\tdef validate_for_repost(self):\n\t\tself.validate_write_off_account()\n\t\tself.validate_account_for_change_amount()\n\t\tself.validate_income_account()\n\t\tvalidate_docs_for_voucher_types([\"Sales Invoice\"])\n\t\tvalidate_docs_for_deferred_accounting([self.name], [])\n\n\tdef validate_fixed_asset(self):\n\t\tif self.doctype != \"Sales Invoice\":\n\t\t\treturn\n\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.is_fixed_asset:\n\t\t\t\tif d.asset:\n\t\t\t\t\tif not self.is_return:\n\t\t\t\t\t\tasset_status = frappe.db.get_value(\"Asset\", d.asset, \"status\")\n\t\t\t\t\t\tif self.update_stock:\n\t\t\t\t\t\t\tfrappe.throw(_(\"'Update Stock' cannot be checked for fixed asset sale\"))\n\n\t\t\t\t\t\telif asset_status in (\"Scrapped\", \"Cancelled\", \"Capitalized\"):\n\t\t\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t\t\t_(\"Row #{0}: Asset {1} cannot be sold, it is already {2}\").format(\n\t\t\t\t\t\t\t\t\td.idx, d.asset, asset_status\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\telif asset_status == \"Sold\" and not self.is_return:\n\t\t\t\t\t\t\tfrappe.throw(_(\"Row #{0}: Asset {1} is already sold\").format(d.idx, d.asset))\n\t\t\t\t\telif not self.return_against:\n\t\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t\t_(\"Row #{0}: Return Against is required for returning asset\").format(d.idx)\n\t\t\t\t\t\t)\n\t\t\t\telse:\n\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t_(\"Row #{0}: You must select an Asset for Item {1}.\").format(d.idx, d.item_code),\n\t\t\t\t\t\ttitle=_(\"Missing Asset\"),\n\t\t\t\t\t)\n\n\tdef validate_item_cost_centers(self):\n\t\tfor item in self.items:\n\t\t\titem.validate_cost_center(self.company)\n\n\tdef validate_income_account(self):\n\t\tfor item in self.get(\"items\"):\n\t\t\tvalidate_account_head(item.idx, item.income_account, self.company, _(\"Income\"))\n\n\tdef before_save(self):\n\t\tself.set_account_for_mode_of_payment()\n\t\tself.set_paid_amount()\n\n\tdef before_submit(self):\n\t\tself.add_remarks()\n\n\tdef on_submit(self):\n\t\tself.validate_pos_paid_amount()\n\n\t\tif not self.auto_repeat:\n\t\t\tfrappe.get_cached_doc(\"Authorization Control\").validate_approving_authority(\n\t\t\t\tself.doctype, self.company, self.base_grand_total, self\n\t\t\t)\n\n\t\tself.check_prev_docstatus()\n\n\t\tif self.is_return and not self.update_billed_amount_in_sales_order:\n\t\t\t# NOTE status updating bypassed for is_return\n\t\t\tself.status_updater = []\n\n\t\tSalesTaxWithholding(self).on_submit()\n\n\t\tself.update_status_updater_args()\n\t\tself.update_prevdoc_status()\n\n\t\tself.update_billing_status_in_dn()\n\t\tself.clear_unallocated_mode_of_payments()\n\n\t\t# Updating stock ledger should always be called after updating prevdoc status,\n\t\t# because updating reserved qty in bin depends upon updated delivered qty in SO\n\t\tif self.update_stock == 1:\n\t\t\tfor table_name in [\"items\", \"packed_items\"]:\n\t\t\t\tif not self.get(table_name):\n\t\t\t\t\tcontinue\n\n\t\t\t\tself.make_bundle_for_sales_purchase_return(table_name)\n\t\t\t\tself.make_bundle_using_old_serial_batch_fields(table_name)\n\n\t\t\tself.validate_standalone_serial_nos_customer()\n\t\t\tself.update_stock_reservation_entries()\n\t\t\tself.update_stock_ledger()\n\n\t\tself.split_asset_based_on_sale_qty()\n\n\t\tself.process_asset_depreciation()\n\n\t\t# this sequence because outstanding may get -ve\n\t\tself.make_gl_entries()\n\n\t\tif self.update_stock == 1:\n\t\t\tself.repost_future_sle_and_gle()\n\n\t\tif not self.is_return:\n\t\t\tself.update_billing_status_for_zero_amount_refdoc(\"Delivery Note\")\n\t\t\tself.update_billing_status_for_zero_amount_refdoc(\"Sales Order\")\n\t\t\tself.check_credit_limit()\n\n\t\tif cint(self.is_pos) != 1 and not self.is_return:\n\t\t\tself.update_against_document_in_jv()\n\n\t\tself.update_time_sheet(None if (self.is_return and self.return_against) else self.name)\n\n\t\tif frappe.get_single_value(\"Selling Settings\", \"sales_update_frequency\") == \"Each Transaction\":\n\t\t\tupdate_company_current_month_sales(self.company)\n\t\t\tself.update_project()\n\t\tupdate_linked_doc(self.doctype, self.name, self.inter_company_invoice_reference)\n\n\t\tif self.coupon_code:\n\t\t\tupdate_coupon_code_count(self.coupon_code, \"used\")\n\n\t\t# create the loyalty point ledger entry if the customer is enrolled in any loyalty program\n\t\tif (\n\t\t\tnot self.is_return\n\t\t\tand not self.is_consolidated\n\t\t\tand self.loyalty_program\n\t\t\tand not self.dont_create_loyalty_points\n\t\t):\n\t\t\tself.make_loyalty_point_entry()\n\t\telif self.is_return and self.return_against and not self.is_consolidated and self.loyalty_program:\n\t\t\tagainst_si_doc = frappe.get_doc(\"Sales Invoice\", self.return_against)\n\t\t\tagainst_si_doc.delete_loyalty_point_entry()\n\t\t\tagainst_si_doc.make_loyalty_point_entry()\n\t\tif self.redeem_loyalty_points and not self.is_consolidated and self.loyalty_points:\n\t\t\tself.apply_loyalty_points()\n\n\t\tself.process_common_party_accounting()\n\t\tself.update_billed_qty_in_scio()\n\n\tdef validate_pos_return(self):\n\t\tif self.is_consolidated:\n\t\t\t# pos return is already validated in pos invoice\n\t\t\treturn\n\n\t\tif self.is_pos and self.is_return:\n\t\t\ttotal_amount_in_payments = 0\n\t\t\tfor payment in self.payments:\n\t\t\t\ttotal_amount_in_payments += payment.amount\n\t\t\tinvoice_total = self.rounded_total or self.grand_total\n\t\t\tif total_amount_in_payments < invoice_total:\n\t\t\t\tfrappe.throw(_(\"Total payments amount can't be greater than {}\").format(-invoice_total))\n\n\tdef validate_pos_paid_amount(self):\n\t\tif len(self.payments) == 0 and self.is_pos and flt(self.grand_total) > 0:\n\t\t\tfrappe.throw(_(\"At least one mode of payment is required for POS invoice.\"))\n\n\tdef check_if_consolidated_invoice(self):\n\t\t# since POS Invoice extends Sales Invoice, we explicitly check if doctype is Sales Invoice\n\t\tif self.doctype == \"Sales Invoice\" and self.is_consolidated:\n\t\t\tinvoice_or_credit_note = \"consolidated_credit_note\" if self.is_return else \"consolidated_invoice\"\n\t\t\tpos_closing_entry = frappe.get_all(\n\t\t\t\t\"POS Invoice Merge Log\",\n\t\t\t\tfilters={invoice_or_credit_note: self.name},\n\t\t\t\tpluck=\"pos_closing_entry\",\n\t\t\t)\n\t\t\tif pos_closing_entry and pos_closing_entry[0]:\n\t\t\t\tmsg = _(\"To cancel a {} you need to cancel the POS Closing Entry {}.\").format(\n\t\t\t\t\tfrappe.bold(_(\"Consolidated Sales Invoice\")),\n\t\t\t\t\tget_link_to_form(\"POS Closing Entry\", pos_closing_entry[0]),\n\t\t\t\t)\n\t\t\t\tfrappe.throw(msg, title=_(\"Not Allowed\"))\n\n\tdef check_if_created_using_pos_and_pos_closing_entry_generated(self):\n\t\tif self.doctype == \"Sales Invoice\" and self.is_created_using_pos and self.pos_closing_entry:\n\t\t\tpos_closing_entry_docstatus = frappe.db.get_value(\n\t\t\t\t\"POS Closing Entry\", self.pos_closing_entry, \"docstatus\"\n\t\t\t)\n\t\t\tif pos_closing_entry_docstatus == 1:\n\t\t\t\tfrappe.throw(\n\t\t\t\t\tmsg=_(\"To cancel this Sales Invoice you need to cancel the POS Closing Entry {}.\").format(\n\t\t\t\t\t\tget_link_to_form(\"POS Closing Entry\", self.pos_closing_entry)\n\t\t\t\t\t),\n\t\t\t\t\ttitle=_(\"Not Allowed\"),\n\t\t\t\t)\n\n\tdef before_cancel(self):\n\t\t# check if generated via POS and already included in POS Closing Entry\n\t\tself.check_if_created_using_pos_and_pos_closing_entry_generated()\n\t\tself.check_if_consolidated_invoice()\n\n\t\tsuper().before_cancel()\n\t\tself.update_time_sheet(self.return_against if (self.is_return and self.return_against) else None)\n\n\tdef on_cancel(self):\n\t\tcheck_if_return_invoice_linked_with_payment_entry(self)\n\n\t\tsuper().on_cancel()\n\n\t\tself.check_sales_order_on_hold_or_close(\"sales_order\")\n\n\t\tif self.is_return and not self.update_billed_amount_in_sales_order:\n\t\t\t# NOTE status updating bypassed for is_return\n\t\t\tself.status_updater = []\n\n\t\tself.update_status_updater_args()\n\t\tself.update_prevdoc_status()\n\t\tself.update_billing_status_in_dn()\n\n\t\tif not self.is_return:\n\t\t\tself.update_billing_status_for_zero_amount_refdoc(\"Delivery Note\")\n\t\t\tself.update_billing_status_for_zero_amount_refdoc(\"Sales Order\")\n\n\t\t# Updating stock ledger should always be called after updating prevdoc status,\n\t\t# because updating reserved qty in bin depends upon updated delivered qty in SO\n\t\tSalesTaxWithholding(self).on_cancel()\n\t\tif self.update_stock == 1:\n\t\t\tself.update_stock_ledger()\n\n\t\tself.process_asset_depreciation()\n\n\t\tself.make_gl_entries_on_cancel()\n\n\t\tif self.update_stock == 1:\n\t\t\tself.update_stock_reservation_entries()\n\t\t\tself.repost_future_sle_and_gle()\n\n\t\tself.db_set(\"status\", \"Cancelled\")\n\n\t\tif self.coupon_code:\n\t\t\tupdate_coupon_code_count(self.coupon_code, \"cancelled\")\n\n\t\tif frappe.get_single_value(\"Selling Settings\", \"sales_update_frequency\") == \"Each Transaction\":\n\t\t\tupdate_company_current_month_sales(self.company)\n\t\t\tself.update_project()\n\t\tif not self.is_return and not self.is_consolidated and self.loyalty_program:\n\t\t\tself.delete_loyalty_point_entry()\n\t\telif self.is_return and self.return_against and not self.is_consolidated and self.loyalty_program:\n\t\t\tagainst_si_doc = frappe.get_doc(\"Sales Invoice\", self.return_against)\n\t\t\tagainst_si_doc.delete_loyalty_point_entry()\n\t\t\tagainst_si_doc.make_loyalty_point_entry()\n\n\t\tunlink_inter_company_doc(self.doctype, self.name, self.inter_company_invoice_reference)\n\n\t\tself.unlink_sales_invoice_from_timesheets()\n\t\tself.ignore_linked_doctypes = (\n\t\t\t\"GL Entry\",\n\t\t\t\"Stock Ledger Entry\",\n\t\t\t\"Repost Item Valuation\",\n\t\t\t\"Repost Payment Ledger\",\n\t\t\t\"Repost Payment Ledger Items\",\n\t\t\t\"Repost Accounting Ledger\",\n\t\t\t\"Repost Accounting Ledger Items\",\n\t\t\t\"Unreconcile Payment\",\n\t\t\t\"Unreconcile Payment Entries\",\n\t\t\t\"Payment Ledger Entry\",\n\t\t\t\"Serial and Batch Bundle\",\n\t\t\t\"Tax Withholding Entry\",\n\t\t)\n\n\t\tself.delete_auto_created_batches()\n\n\t\tif (\n\t\t\tself.doctype == \"Sales Invoice\"\n\t\t\tand self.is_pos\n\t\t\tand self.is_return\n\t\t\tand self.is_created_using_pos\n\t\t\tand not self.pos_closing_entry\n\t\t):\n\t\t\tself.cancel_pos_invoice_credit_note_generated_during_sales_invoice_mode()\n\n\t\tself.update_billed_qty_in_scio()\n\n\tdef update_status_updater_args(self):\n\t\tif not cint(self.update_stock):\n\t\t\treturn\n\n\t\tself.status_updater.append(\n\t\t\t{\n\t\t\t\t\"source_dt\": \"Sales Invoice Item\",\n\t\t\t\t\"target_dt\": \"Sales Order Item\",\n\t\t\t\t\"target_parent_dt\": \"Sales Order\",\n\t\t\t\t\"target_parent_field\": \"per_delivered\",\n\t\t\t\t\"target_field\": \"delivered_qty\",\n\t\t\t\t\"target_ref_field\": \"qty\",\n\t\t\t\t\"source_field\": \"qty\",\n\t\t\t\t\"join_field\": \"so_detail\",\n\t\t\t\t\"percent_join_field\": \"sales_order\",\n\t\t\t\t\"status_field\": \"delivery_status\",\n\t\t\t\t\"keyword\": \"Delivered\",\n\t\t\t\t\"second_source_dt\": \"Delivery Note Item\",\n\t\t\t\t\"second_source_field\": \"qty\",\n\t\t\t\t\"second_join_field\": \"so_detail\",\n\t\t\t\t\"overflow_type\": \"delivery\",\n\t\t\t\t\"extra_cond\": \"\"\" and exists(select name from `tabSales Invoice`\n\t\t\t\twhere name=`tabSales Invoice Item`.parent and update_stock = 1)\"\"\",\n\t\t\t}\n\t\t)\n\n\t\tif not cint(self.is_return):\n\t\t\treturn\n\n\t\tself.status_updater.append(\n\t\t\t{\n\t\t\t\t\"source_dt\": \"Sales Invoice Item\",\n\t\t\t\t\"target_dt\": \"Sales Order Item\",\n\t\t\t\t\"join_field\": \"so_detail\",\n\t\t\t\t\"target_field\": \"returned_qty\",\n\t\t\t\t\"target_parent_dt\": \"Sales Order\",\n\t\t\t\t\"source_field\": \"-1 * qty\",\n\t\t\t\t\"second_source_dt\": \"Delivery Note Item\",\n\t\t\t\t\"second_source_field\": \"-1 * qty\",\n\t\t\t\t\"second_join_field\": \"so_detail\",\n\t\t\t\t\"extra_cond\": \"\"\" and exists (select name from `tabSales Invoice` where name=`tabSales Invoice Item`.parent and update_stock=1 and is_return=1)\"\"\",\n\t\t\t}\n\t\t)\n\n\tdef check_credit_limit(self):\n\t\tfrom erpnext.selling.doctype.customer.customer import check_credit_limit\n\n\t\tvalidate_against_credit_limit = False\n\t\tbypass_credit_limit_check_at_sales_order = frappe.db.get_value(\n\t\t\t\"Customer Credit Limit\",\n\t\t\tfilters={\"parent\": self.customer, \"parenttype\": \"Customer\", \"company\": self.company},\n\t\t\tfieldname=[\"bypass_credit_limit_check\"],\n\t\t)\n\n\t\tif bypass_credit_limit_check_at_sales_order:\n\t\t\tvalidate_against_credit_limit = True\n\n\t\tfor d in self.get(\"items\"):\n\t\t\tif not (d.sales_order or d.delivery_note):\n\t\t\t\tvalidate_against_credit_limit = True\n\t\t\t\tbreak\n\t\tif validate_against_credit_limit:\n\t\t\tcheck_credit_limit(self.customer, self.company, bypass_credit_limit_check_at_sales_order)\n\n\tdef unlink_sales_invoice_from_timesheets(self):\n\t\tfor row in self.timesheets:\n\t\t\ttimesheet = frappe.get_doc(\"Timesheet\", row.time_sheet)\n\t\t\ttimesheet.unlink_sales_invoice(self.name)\n\t\t\ttimesheet.flags.ignore_validate_update_after_submit = True\n\t\t\ttimesheet.db_update_all()\n\n\tdef cancel_pos_invoice_credit_note_generated_during_sales_invoice_mode(self):\n\t\tpos_invoices = frappe.get_all(\n\t\t\t\"POS Invoice\", filters={\"consolidated_invoice\": self.name}, pluck=\"name\"\n\t\t)\n\t\tif pos_invoices:\n\t\t\tfor pos_invoice in pos_invoices:\n\t\t\t\tpos_invoice_doc = frappe.get_doc(\"POS Invoice\", pos_invoice)\n\t\t\t\tpos_invoice_doc.cancel()\n\n\t@frappe.whitelist()\n\tdef set_missing_values(self, for_validate=False):\n\t\tpos = self.set_pos_fields(for_validate)\n\n\t\tif not self.debit_to:\n\t\t\tself.debit_to = get_party_account(\"Customer\", self.customer, self.company)\n\t\t\tself.party_account_currency = frappe.db.get_value(\n\t\t\t\t\"Account\", self.debit_to, \"account_currency\", cache=True\n\t\t\t)\n\t\tif not self.due_date and self.customer:\n\t\t\tself.due_date = get_due_date(\n\t\t\t\tself.posting_date,\n\t\t\t\t\"Customer\",\n\t\t\t\tself.customer,\n\t\t\t\tself.company,\n\t\t\t\ttemplate_name=self.payment_terms_template,\n\t\t\t)\n\n\t\tsuper().set_missing_values(for_validate)\n\n\t\tprint_format = pos.get(\"print_format\") if pos else None\n\t\tif not print_format and not cint(frappe.db.get_value(\"Print Format\", \"POS Invoice\", \"disabled\")):\n\t\t\tprint_format = \"POS Invoice\"\n\n\t\tif pos:\n\t\t\treturn {\n\t\t\t\t\"print_format\": print_format,\n\t\t\t\t\"allow_edit_rate\": pos.get(\"allow_user_to_edit_rate\"),\n\t\t\t\t\"allow_edit_discount\": pos.get(\"allow_user_to_edit_discount\"),\n\t\t\t\t\"utm_source\": pos.get(\"utm_source\"),\n\t\t\t\t\"utm_campaign\": pos.get(\"utm_campaign\"),\n\t\t\t\t\"utm_medium\": pos.get(\"utm_medium\"),\n\t\t\t\t\"allow_print_before_pay\": pos.get(\"allow_print_before_pay\"),\n\t\t\t\t\"set_default_payment\": pos.get(\"set_grand_total_to_default_mop\", 1),\n\t\t\t}\n\n\t@frappe.whitelist()\n\tdef reset_mode_of_payments(self):\n\t\tif self.pos_profile:\n\t\t\tpos_profile = frappe.get_cached_doc(\"POS Profile\", self.pos_profile)\n\t\t\tupdate_multi_mode_option(self, pos_profile)\n\t\t\tself.paid_amount = 0\n\n\tdef update_time_sheet(self, sales_invoice):\n\t\tfor d in self.timesheets:\n\t\t\tif d.time_sheet:\n\t\t\t\ttimesheet = frappe.get_doc(\"Timesheet\", d.time_sheet)\n\t\t\t\tself.update_time_sheet_detail(timesheet, d, sales_invoice)\n\t\t\t\ttimesheet.calculate_total_amounts()\n\t\t\t\ttimesheet.calculate_percentage_billed()\n\t\t\t\ttimesheet.flags.ignore_validate_update_after_submit = True\n\t\t\t\ttimesheet.set_status()\n\t\t\t\ttimesheet.db_update_all()\n\n\tdef update_billed_qty_in_scio(self):\n\t\tif self.is_return:\n\t\t\treturn\n\n\t\ttable = frappe.qb.DocType(\"Subcontracting Inward Order Received Item\")\n\t\tdata = frappe._dict(\n\t\t\t{\n\t\t\t\titem.scio_detail: item.stock_qty if self._action == \"submit\" else -item.stock_qty\n\t\t\t\tfor item in self.items\n\t\t\t\tif item.scio_detail\n\t\t\t}\n\t\t)\n\n\t\tif data:\n\t\t\tcase_expr = Case()\n\t\t\tfor name, qty in data.items():\n\t\t\t\tcase_expr = case_expr.when(table.name == name, table.billed_qty + qty)\n\t\t\tfrappe.qb.update(table).set(table.billed_qty, case_expr).where(\n\t\t\t\t(table.name.isin(list(data.keys()))) & (table.docstatus == 1)\n\t\t\t).run()\n\n\tdef update_time_sheet_detail(self, timesheet, args, sales_invoice):\n\t\tfor data in timesheet.time_logs:\n\t\t\tif (\n\t\t\t\t(self.project and args.timesheet_detail == data.name)\n\t\t\t\tor (not self.project and not data.sales_invoice and args.timesheet_detail == data.name)\n\t\t\t\tor (\n\t\t\t\t\tnot sales_invoice\n\t\t\t\t\tand data.sales_invoice == self.name\n\t\t\t\t\tand args.timesheet_detail == data.name\n\t\t\t\t)\n\t\t\t\tor (\n\t\t\t\t\tself.is_return\n\t\t\t\t\tand self.return_against\n\t\t\t\t\tand data.sales_invoice\n\t\t\t\t\tand data.sales_invoice == self.return_against\n\t\t\t\t\tand not sales_invoice\n\t\t\t\t\tand args.timesheet_detail == data.name\n\t\t\t\t)\n\t\t\t):\n\t\t\t\tdata.sales_invoice = sales_invoice\n\n\tdef on_update_after_submit(self):\n\t\tfields_to_check = [\n\t\t\t\"additional_discount_account\",\n\t\t\t\"cash_bank_account\",\n\t\t\t\"account_for_change_amount\",\n\t\t\t\"write_off_account\",\n\t\t\t\"loyalty_redemption_account\",\n\t\t\t\"unrealized_profit_loss_account\",\n\t\t\t\"is_opening\",\n\t\t]\n\t\tchild_tables = {\n\t\t\t\"items\": (\"income_account\", \"expense_account\", \"discount_account\"),\n\t\t\t\"taxes\": (\"account_head\",),\n\t\t}\n\t\tself.needs_repost = self.check_if_fields_updated(fields_to_check, child_tables)\n\t\tif self.needs_repost:\n\t\t\tself.validate_for_repost()\n\t\t\tself.repost_accounting_entries()\n\n\tdef set_paid_amount(self):\n\t\tpaid_amount = 0.0\n\t\tbase_paid_amount = 0.0\n\t\tfor data in self.payments:\n\t\t\tdata.base_amount = flt(data.amount * self.conversion_rate, self.precision(\"base_paid_amount\"))\n\t\t\tpaid_amount += data.amount\n\t\t\tbase_paid_amount += data.base_amount\n\n\t\tself.paid_amount = paid_amount\n\t\tself.base_paid_amount = base_paid_amount\n\n\t@frappe.whitelist()\n\tdef set_account_for_mode_of_payment(self):\n\t\tfor payment in self.payments:\n\t\t\tpayment.account = get_bank_cash_account(payment.mode_of_payment, self.company).get(\"account\")\n\n\tdef validate_time_sheets_are_submitted(self):\n\t\t# Note: This validation is skipped for return invoices\n\t\t# to allow returns to reference already-billed timesheet details\n\t\tfor data in self.timesheets:\n\t\t\t# Handle invoice duplication\n\t\t\tif data.time_sheet and data.timesheet_detail:\n\t\t\t\tif sales_invoice := frappe.db.get_value(\n\t\t\t\t\t\"Timesheet Detail\", data.timesheet_detail, \"sales_invoice\"\n\t\t\t\t):\n\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t_(\"Row {0}: Sales Invoice {1} is already created for {2}\").format(\n\t\t\t\t\t\t\tdata.idx, frappe.bold(sales_invoice), frappe.bold(data.time_sheet)\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\t\t\tif data.time_sheet:\n\t\t\t\tstatus = frappe.db.get_value(\"Timesheet\", data.time_sheet, \"status\")\n\t\t\t\tif status not in [\"Submitted\", \"Payslip\", \"Partially Billed\"]:\n\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t_(\"Timesheet {0} cannot be invoiced in its current state\").format(data.time_sheet)\n\t\t\t\t\t)\n\n\tdef set_pos_fields(self, for_validate=False):\n\t\t\"\"\"Set retail related fields from POS Profiles\"\"\"\n\t\tif cint(self.is_pos) != 1:\n\t\t\treturn\n\n\t\tif not self.account_for_change_amount:\n\t\t\tself.account_for_change_amount = frappe.get_cached_value(\n\t\t\t\t\"Company\", self.company, \"default_cash_account\"\n\t\t\t)\n\n\t\tfrom erpnext.stock.get_item_details import (\n\t\t\tItemDetailsCtx,\n\t\t\tget_pos_profile,\n\t\t\tget_pos_profile_item_details_,\n\t\t)\n\n\t\tif not self.pos_profile and not self.flags.ignore_pos_profile:\n\t\t\tpos_profile = get_pos_profile(self.company) or {}\n\t\t\tif not pos_profile:\n\t\t\t\treturn\n\t\t\tself.pos_profile = pos_profile.get(\"name\")\n\n\t\tpos = {}\n\t\tif self.pos_profile:\n\t\t\tpos = frappe.get_doc(\"POS Profile\", self.pos_profile)\n\n\t\tif not self.get(\"payments\") and not for_validate:\n\t\t\tupdate_multi_mode_option(self, pos)\n\n\t\tif pos:\n\t\t\tif not for_validate:\n\t\t\t\tself.tax_category = pos.get(\"tax_category\")\n\n\t\t\tif not for_validate and not self.customer:\n\t\t\t\tself.customer = pos.customer\n\n\t\t\tif not for_validate:\n\t\t\t\tself.ignore_pricing_rule = pos.ignore_pricing_rule\n\n\t\t\tif pos.get(\"account_for_change_amount\"):\n\t\t\t\tself.account_for_change_amount = pos.get(\"account_for_change_amount\")\n\n\t\t\tfor fieldname in (\n\t\t\t\t\"currency\",\n\t\t\t\t\"letter_head\",\n\t\t\t\t\"tc_name\",\n\t\t\t\t\"company\",\n\t\t\t\t\"select_print_heading\",\n\t\t\t\t\"write_off_account\",\n\t\t\t\t\"taxes_and_charges\",\n\t\t\t\t\"write_off_cost_center\",\n\t\t\t\t\"apply_discount_on\",\n\t\t\t\t\"cost_center\",\n\t\t\t):\n\t\t\t\tif (not for_validate) or (for_validate and not self.get(fieldname)):\n\t\t\t\t\tself.set(fieldname, pos.get(fieldname))\n\n\t\t\tif pos.get(\"company_address\"):\n\t\t\t\tself.company_address = pos.get(\"company_address\")\n\n\t\t\tif self.customer:\n\t\t\t\tcustomer_price_list, customer_group = frappe.get_value(\n\t\t\t\t\t\"Customer\", self.customer, [\"default_price_list\", \"customer_group\"]\n\t\t\t\t)\n\t\t\t\tcustomer_group_price_list = frappe.get_value(\n\t\t\t\t\t\"Customer Group\", customer_group, \"default_price_list\"\n\t\t\t\t)\n\t\t\t\tselling_price_list = (\n\t\t\t\t\tcustomer_price_list or customer_group_price_list or pos.get(\"selling_price_list\")\n\t\t\t\t)\n\t\t\telse:\n\t\t\t\tselling_price_list = pos.get(\"selling_price_list\")\n\n\t\t\tif selling_price_list:\n\t\t\t\tself.set(\"selling_price_list\", selling_price_list)\n\n\t\t\tif not for_validate:\n\t\t\t\tself.update_stock = cint(pos.get(\"update_stock\"))\n\n\t\t\t# set pos values in items\n\t\t\tfor item in self.get(\"items\"):\n\t\t\t\tif item.get(\"item_code\"):\n\t\t\t\t\tprofile_details = get_pos_profile_item_details_(\n\t\t\t\t\t\tItemDetailsCtx(item.as_dict()), pos, pos, update_data=True\n\t\t\t\t\t)\n\t\t\t\t\tfor fname, val in profile_details.items():\n\t\t\t\t\t\tif (not for_validate) or (for_validate and not item.get(fname)):\n\t\t\t\t\t\t\titem.set(fname, val)\n\n\t\t\t# fetch terms\n\t\t\tif self.tc_name and not self.terms:\n\t\t\t\tself.terms = frappe.db.get_value(\"Terms and Conditions\", self.tc_name, \"terms\")\n\n\t\t\t# fetch charges\n\t\t\tif self.taxes_and_charges and not len(self.get(\"taxes\")):\n\t\t\t\tself.set_taxes()\n\n\t\treturn pos\n\n\tdef get_company_abbr(self):\n\t\treturn frappe.db.sql(\"select abbr from tabCompany where name=%s\", self.company)[0][0]\n\n\tdef validate_debit_to_acc(self):\n\t\tif not self.debit_to:\n\t\t\tself.debit_to = get_party_account(\"Customer\", self.customer, self.company)\n\t\t\tif not self.debit_to:\n\t\t\t\tself.raise_missing_debit_credit_account_error(\"Customer\", self.customer)\n\n\t\taccount = frappe.get_cached_value(\n\t\t\t\"Account\", self.debit_to, [\"account_type\", \"report_type\", \"account_currency\"], as_dict=True\n\t\t)\n\n\t\tif not account:\n\t\t\tfrappe.throw(_(\"Debit To is required\"), title=_(\"Account Missing\"))\n\n\t\tif account.report_type != \"Balance Sheet\":\n\t\t\tmsg = (\n\t\t\t\t_(\"Please ensure {} account is a Balance Sheet account.\").format(frappe.bold(_(\"Debit To\")))\n\t\t\t\t+ \" \"\n\t\t\t)\n\t\t\tmsg += _(\n\t\t\t\t\"You can change the parent account to a Balance Sheet account or select a different account.\"\n\t\t\t)\n\t\t\tfrappe.throw(msg, title=_(\"Invalid Account\"))\n\n\t\tif self.customer and account.account_type != \"Receivable\":\n\t\t\tmsg = (\n\t\t\t\t_(\"Please ensure {} account {} is a Receivable account.\").format(\n\t\t\t\t\tfrappe.bold(_(\"Debit To\")), frappe.bold(self.debit_to)\n\t\t\t\t)\n\t\t\t\t+ \" \"\n\t\t\t)\n\t\t\tmsg += _(\"Change the account type to Receivable or select a different account.\")\n\t\t\tfrappe.throw(msg, title=_(\"Invalid Account\"))\n\n\t\tself.party_account_currency = account.account_currency\n\n\tdef clear_unallocated_mode_of_payments(self):\n\t\tself.set(\"payments\", self.get(\"payments\", {\"amount\": [\"not in\", [0, None, \"\"]]}))\n\n\t\tfrappe.db.sql(\n\t\t\t\"\"\"delete from `tabSales Invoice Payment` where parent = %s\n\t\t\tand amount = 0\"\"\",\n\t\t\tself.name,\n\t\t)\n\n\tdef validate_with_previous_doc(self):\n\t\tsuper().validate_with_previous_doc(\n\t\t\t{\n\t\t\t\t\"Sales Order\": {\n\t\t\t\t\t\"ref_dn_field\": \"sales_order\",\n\t\t\t\t\t\"compare_fields\": [\n\t\t\t\t\t\t[\"customer\", \"=\"],\n\t\t\t\t\t\t[\"company\", \"=\"],\n\t\t\t\t\t\t[\"project\", \"=\"],\n\t\t\t\t\t\t[\"currency\", \"=\"],\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t\t\"Sales Order Item\": {\n\t\t\t\t\t\"ref_dn_field\": \"so_detail\",\n\t\t\t\t\t\"compare_fields\": [[\"item_code\", \"=\"], [\"uom\", \"=\"], [\"conversion_factor\", \"=\"]],\n\t\t\t\t\t\"is_child_table\": True,\n\t\t\t\t\t\"allow_duplicate_prev_row_id\": True,\n\t\t\t\t},\n\t\t\t\t\"Delivery Note\": {\n\t\t\t\t\t\"ref_dn_field\": \"delivery_note\",\n\t\t\t\t\t\"compare_fields\": [\n\t\t\t\t\t\t[\"customer\", \"=\"],\n\t\t\t\t\t\t[\"company\", \"=\"],\n\t\t\t\t\t\t[\"project\", \"=\"],\n\t\t\t\t\t\t[\"currency\", \"=\"],\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t\t\"Delivery Note Item\": {\n\t\t\t\t\t\"ref_dn_field\": \"dn_detail\",\n\t\t\t\t\t\"compare_fields\": [[\"item_code\", \"=\"], [\"uom\", \"=\"], [\"conversion_factor\", \"=\"]],\n\t\t\t\t\t\"is_child_table\": True,\n\t\t\t\t\t\"allow_duplicate_prev_row_id\": True,\n\t\t\t\t},\n\t\t\t}\n\t\t)\n\n\t\tif (\n\t\t\tcint(frappe.get_single_value(\"Selling Settings\", \"maintain_same_sales_rate\"))\n\t\t\tand not self.is_return\n\t\t\tand not self.is_internal_customer\n\t\t):\n\t\t\tself.validate_rate_with_reference_doc(\n\t\t\t\t[[\"Sales Order\", \"sales_order\", \"so_detail\"], [\"Delivery Note\", \"delivery_note\", \"dn_detail\"]]\n\t\t\t)\n\n\tdef set_against_income_account(self):\n\t\t\"\"\"Set against account for debit to account\"\"\"\n\t\tagainst_acc = []\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.income_account and d.income_account not in against_acc:\n\t\t\t\tagainst_acc.append(d.income_account)\n\t\tself.against_income_account = \",\".join(against_acc)\n\n\tdef force_set_against_income_account(self):\n\t\tself.set_against_income_account()\n\t\tfrappe.db.set_value(self.doctype, self.name, \"against_income_account\", self.against_income_account)\n\n\tdef add_remarks(self):\n\t\tif not self.remarks:\n\t\t\tif self.po_no:\n\t\t\t\tself.remarks = _(\"Against Customer Order {0}\").format(self.po_no)\n\t\t\t\tif self.po_date:\n\t\t\t\t\tself.remarks += \" \" + _(\"dated {0}\").format(formatdate(self.po_date))\n\n\t\t\telse:\n\t\t\t\tself.remarks = _(\"No Remarks\")\n\n\tdef validate_auto_set_posting_time(self):\n\t\t# Don't auto set the posting date and time if invoice is amended\n\t\tif self.is_new() and self.amended_from:\n\t\t\tself.set_posting_time = 1\n\n\t\tself.validate_posting_time()\n\n\tdef so_dn_required(self):\n\t\t\"\"\"check in manage account if sales order / delivery note required or not.\"\"\"\n\t\tif self.is_return:\n\t\t\treturn\n\n\t\tprev_doc_field_map = {\n\t\t\t\"Sales Order\": [\"so_required\", \"is_pos\"],\n\t\t\t\"Delivery Note\": [\"dn_required\", \"update_stock\"],\n\t\t}\n\t\tfor key, value in prev_doc_field_map.items():\n\t\t\tif frappe.get_single_value(\"Selling Settings\", value[0]) == \"Yes\":\n\t\t\t\tif frappe.get_value(\"Customer\", self.customer, value[0]):\n\t\t\t\t\tcontinue\n\n\t\t\t\tfor d in self.get(\"items\"):\n\t\t\t\t\tif d.item_code and not d.get(key.lower().replace(\" \", \"_\")) and not self.get(value[1]):\n\t\t\t\t\t\tmsgprint(\n\t\t\t\t\t\t\t_(\"{0} is mandatory for Item {1}\").format(key, d.item_code), raise_exception=1\n\t\t\t\t\t\t)\n\n\tdef validate_proj_cust(self):\n\t\t\"\"\"check for does customer belong to same project as entered..\"\"\"\n\t\tif self.project and self.customer:\n\t\t\tres = frappe.db.sql(\n\t\t\t\t\"\"\"select name from `tabProject`\n\t\t\t\twhere name = %s and (customer = %s or customer is null or customer = '')\"\"\",\n\t\t\t\t(self.project, self.customer),\n\t\t\t)\n\t\t\tif not res:\n\t\t\t\tthrow(_(\"Customer {0} does not belong to project {1}\").format(self.customer, self.project))\n\n\tdef validate_pos(self):\n\t\tif self.is_return:\n\t\t\tinvoice_total = self.rounded_total or self.grand_total\n\t\t\tif abs(flt(self.paid_amount)) + abs(flt(self.write_off_amount)) - abs(\n\t\t\t\tflt(invoice_total)\n\t\t\t) > 1.0 / (10.0 ** (self.precision(\"grand_total\") + 1.0)):\n\t\t\t\tfrappe.throw(_(\"Paid amount + Write Off Amount can not be greater than Grand Total\"))\n\n\tdef validate_created_using_pos(self):\n\t\tif self.is_created_using_pos and not self.pos_profile:\n\t\t\tfrappe.throw(_(\"POS Profile is mandatory to mark this invoice as POS Transaction.\"))\n\n\t\tself.invoice_type_in_pos = frappe.db.get_single_value(\"POS Settings\", \"invoice_type\")\n\t\tif self.invoice_type_in_pos == \"POS Invoice\" and not self.is_return:\n\t\t\tfrappe.throw(_(\"Transactions using Sales Invoice in POS are disabled.\"))\n\n\t\tself.validate_pos_opening_entry()\n\n\tdef validate_full_payment(self):\n\t\tallow_partial_payment = frappe.db.get_value(\"POS Profile\", self.pos_profile, \"allow_partial_payment\")\n\t\tinvoice_total = flt(self.rounded_total) or flt(self.grand_total)\n\n\t\tif (\n\t\t\tself.docstatus == 1\n\t\t\tand not self.is_return\n\t\t\tand not allow_partial_payment\n\t\t\tand self.paid_amount < invoice_total\n\t\t):\n\t\t\tfrappe.throw(\n\t\t\t\tmsg=_(\"Partial Payment in POS Transactions are not allowed.\"),\n\t\t\t\texc=PartialPaymentValidationError,\n\t\t\t)\n\n\tdef validate_pos_opening_entry(self):\n\t\topening_entries = frappe.get_all(\n\t\t\t\"POS Opening Entry\",\n\t\t\tfields=[\"name\", \"period_start_date\"],\n\t\t\tfilters={\"pos_profile\": self.pos_profile, \"status\": \"Open\"},\n\t\t\torder_by=\"period_start_date desc\",\n\t\t)\n\t\tif not opening_entries:\n\t\t\tfrappe.throw(\n\t\t\t\ttitle=_(\"POS Opening Entry Missing\"),\n\t\t\t\tmsg=_(\"No open POS Opening Entry found for POS Profile {0}.\").format(\n\t\t\t\t\tfrappe.bold(self.pos_profile)\n\t\t\t\t),\n\t\t\t)\n\t\tif len(opening_entries) > 1:\n\t\t\tfrappe.throw(\n\t\t\t\ttitle=_(\"Multiple POS Opening Entry\"),\n\t\t\t\tmsg=_(\n\t\t\t\t\t\"POS Profile - {0} has multiple open POS Opening Entries. Please close or cancel the existing entries before proceeding.\"\n\t\t\t\t).format(self.pos_profile),\n\t\t\t)\n\t\tif frappe.utils.get_date_str(opening_entries[0].get(\"period_start_date\")) != frappe.utils.today():\n\t\t\tfrappe.throw(\n\t\t\t\ttitle=_(\"Outdated POS Opening Entry\"),\n\t\t\t\tmsg=_(\n\t\t\t\t\t\"POS Opening Entry - {0} is outdated. Please close the POS and create a new POS Opening Entry.\"\n\t\t\t\t).format(opening_entries[0].get(\"name\")),\n\t\t\t)\n\n\tdef validate_warehouse(self):\n\t\tsuper().validate_warehouse()\n\n\t\tfor d in self.get_item_list():\n\t\t\tif (\n\t\t\t\tnot d.warehouse\n\t\t\t\tand d.item_code\n\t\t\t\tand frappe.get_cached_value(\"Item\", d.item_code, \"is_stock_item\")\n\t\t\t):\n\t\t\t\tfrappe.throw(_(\"Warehouse required for stock Item {0}\").format(d.item_code))\n\n\tdef validate_delivery_note(self):\n\t\t\"\"\"If items are linked with a delivery note, stock cannot be updated again.\"\"\"\n\t\tif not cint(self.update_stock):\n\t\t\treturn\n\n\t\tnotes = [item.delivery_note for item in self.items if item.delivery_note]\n\t\tif notes:\n\t\t\tfrappe.throw(\n\t\t\t\t_(\"Stock cannot be updated against the following Delivery Notes: {0}\").format(\n\t\t\t\t\tcomma_and(notes)\n\t\t\t\t),\n\t\t\t)\n\n\tdef allow_write_off_only_on_pos(self):\n\t\tif not self.is_pos and self.write_off_account:\n\t\t\tself.write_off_account = None\n\n\tdef validate_subcontracted_sales_order(self):\n\t\tif self.has_subcontracted:\n\t\t\tif [item for item in self.items if not item.sales_order and not item.scio_detail]:\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t_(\n\t\t\t\t\t\t\"All items must be linked to a Sales Order or Subcontracting Inward Order for this Sales Invoice.\"\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\tif not all(\n\t\t\t\tfrappe.get_all(\n\t\t\t\t\t\"Sales Order\",\n\t\t\t\t\t{\"name\": [\"in\", [item.sales_order for item in self.items if item.sales_order]]},\n\t\t\t\t\tpluck=\"is_subcontracted\",\n\t\t\t\t)\n\t\t\t):\n\t\t\t\tfrappe.throw(_(\"All linked Sales Orders must be subcontracted.\"))\n\n\tdef validate_scio_self_rm_qty(self):\n\t\tself_rms = [item for item in self.items if item.scio_detail]\n\t\tif self_rms:\n\t\t\ttable = frappe.qb.DocType(\"Subcontracting Inward Order Received Item\")\n\t\t\tquery = (\n\t\t\t\tfrappe.qb.from_(table)\n\t\t\t\t.select(table.required_qty, table.consumed_qty, table.billed_qty, table.name)\n\t\t\t\t.where((table.docstatus == 1) & (table.name.isin([item.scio_detail for item in self_rms])))\n\t\t\t)\n\t\t\tresult = query.run(as_dict=True)\n\t\t\tdata = {item.name: item for item in result}\n\t\t\tfor item in self_rms:\n\t\t\t\trow = data.get(item.scio_detail)\n\t\t\t\tmax_qty = max(row.required_qty, row.consumed_qty) - row.billed_qty\n\t\t\t\tif item.stock_qty > max_qty:\n\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t_(\"Row #{0}: Stock quantity {1} ({2}) for item {3} cannot exceed {4}\").format(\n\t\t\t\t\t\t\titem.idx,\n\t\t\t\t\t\t\titem.stock_qty,\n\t\t\t\t\t\t\titem.stock_uom,\n\t\t\t\t\t\t\tget_link_to_form(\"Item\", item.item_code),\n\t\t\t\t\t\t\tfrappe.bold(max_qty),\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\tdef validate_write_off_account(self):\n\t\tif flt(self.write_off_amount) and not self.write_off_account:\n\t\t\tself.write_off_account = frappe.get_cached_value(\"Company\", self.company, \"write_off_account\")\n\n\t\tif flt(self.write_off_amount) and not self.write_off_account:\n\t\t\tmsgprint(_(\"Please enter Write Off Account\"), raise_exception=1)\n\n\tdef validate_account_for_change_amount(self):\n\t\tif flt(self.change_amount) and not self.account_for_change_amount:\n\t\t\tmsgprint(_(\"Please enter Account for Change Amount\"), raise_exception=1)\n\n\tdef validate_dropship_item(self):\n\t\t\"\"\"If items are drop shipped, stock cannot be updated.\"\"\"\n\t\tif not cint(self.update_stock):\n\t\t\treturn\n\n\t\tif any(item.delivered_by_supplier for item in self.items):\n\t\t\tfrappe.throw(\n\t\t\t\t_(\n\t\t\t\t\t\"Stock cannot be updated because the invoice contains a drop shipping item. Please disable 'Update Stock' or remove the drop shipping item.\"\n\t\t\t\t),\n\t\t\t)\n\n\tdef update_current_stock(self):\n\t\tfor item in self.items:\n\t\t\titem.set_actual_qty()\n\n\t\tfor packed_item in self.packed_items:\n\t\t\tpacked_item.set_actual_and_projected_qty()\n\n\tdef update_packing_list(self):\n\t\tif cint(self.update_stock) == 1:\n\t\t\tfrom erpnext.stock.doctype.packed_item.packed_item import make_packing_list\n\n\t\t\tmake_packing_list(self)\n\t\telse:\n\t\t\tself.set(\"packed_items\", [])\n\n\tdef set_billing_hours_and_amount(self):\n\t\tif not self.project:\n\t\t\tfor timesheet in self.timesheets:\n\t\t\t\tts_doc = frappe.get_doc(\"Timesheet\", timesheet.time_sheet)\n\t\t\t\tif not timesheet.billing_hours and ts_doc.total_billable_hours:\n\t\t\t\t\ttimesheet.billing_hours = ts_doc.total_billable_hours\n\n\t\t\t\tif not timesheet.billing_amount and ts_doc.total_billable_amount:\n\t\t\t\t\ttimesheet.billing_amount = ts_doc.total_billable_amount\n\n\tdef update_timesheet_billing_for_project(self):\n\t\tif (\n\t\t\tnot self.is_return\n\t\t\tand not self.timesheets\n\t\t\tand self.project\n\t\t\tand self.is_auto_fetch_timesheet_enabled()\n\t\t):\n\t\t\tself.add_timesheet_data()\n\t\telse:\n\t\t\tself.calculate_billing_amount_for_timesheet()\n\n\t@frappe.whitelist()\n\tdef is_auto_fetch_timesheet_enabled(self):\n\t\treturn frappe.db.get_single_value(\"Projects Settings\", \"fetch_timesheet_in_sales_invoice\")\n\n\t@frappe.whitelist()\n\tdef add_timesheet_data(self):\n\t\tself.set(\"timesheets\", [])\n\t\tif self.project:\n\t\t\tfor data in get_projectwise_timesheet_data(self.project):\n\t\t\t\tself.append(\n\t\t\t\t\t\"timesheets\",\n\t\t\t\t\t{\n\t\t\t\t\t\t\"time_sheet\": data.time_sheet,\n\t\t\t\t\t\t\"billing_hours\": data.billing_hours,\n\t\t\t\t\t\t\"billing_amount\": data.billing_amount,\n\t\t\t\t\t\t\"timesheet_detail\": data.name,\n\t\t\t\t\t\t\"activity_type\": data.activity_type,\n\t\t\t\t\t\t\"description\": data.description,\n\t\t\t\t\t},\n\t\t\t\t)\n\n\t\t\tself.calculate_billing_amount_for_timesheet()\n\n\tdef calculate_billing_amount_for_timesheet(self):\n\t\tdef timesheet_sum(field):\n\t\t\treturn sum((ts.get(field) or 0.0) for ts in self.timesheets)\n\n\t\tself.total_billing_amount = timesheet_sum(\"billing_amount\")\n\t\tself.total_billing_hours = timesheet_sum(\"billing_hours\")\n\n\tdef get_warehouse(self):\n\t\tuser_pos_profile = frappe.db.sql(\n\t\t\t\"\"\"select name, warehouse from `tabPOS Profile`\n\t\t\twhere ifnull(user,'') = %s and company = %s\"\"\",\n\t\t\t(frappe.session[\"user\"], self.company),\n\t\t)\n\t\twarehouse = user_pos_profile[0][1] if user_pos_profile else None\n\n\t\tif not warehouse:\n\t\t\tglobal_pos_profile = frappe.db.sql(\n\t\t\t\t\"\"\"select name, warehouse from `tabPOS Profile`\n\t\t\t\twhere (user is null or user = '') and company = %s\"\"\",\n\t\t\t\tself.company,\n\t\t\t)\n\n\t\t\tif global_pos_profile:\n\t\t\t\twarehouse = global_pos_profile[0][1]\n\t\t\telif not user_pos_profile:\n\t\t\t\tmsgprint(_(\"POS Profile required to make POS Entry\"), raise_exception=True)\n\n\t\treturn warehouse\n\n\tdef set_income_account_for_fixed_assets(self):\n\t\tfor item in self.items:\n\t\t\titem.set_income_account_for_fixed_asset(self.company)\n\n\tdef check_prev_docstatus(self):\n\t\tfor d in self.get(\"items\"):\n\t\t\tif (\n\t\t\t\td.sales_order\n\t\t\t\tand frappe.db.get_value(\"Sales Order\", d.sales_order, \"docstatus\", cache=True) != 1\n\t\t\t):\n\t\t\t\tfrappe.throw(_(\"Sales Order {0} is not submitted\").format(d.sales_order))\n\n\t\t\tif (\n\t\t\t\td.delivery_note\n\t\t\t\tand frappe.db.get_value(\"Delivery Note\", d.delivery_note, \"docstatus\", cache=True) != 1\n\t\t\t):\n\t\t\t\tthrow(_(\"Delivery Note {0} is not submitted\").format(d.delivery_note))\n\n\tdef split_asset_based_on_sale_qty(self):\n\t\tasset_qty_map = self.get_asset_qty()\n\t\tfor asset, qty in asset_qty_map.items():\n\t\t\tif qty[\"actual_qty\"] < qty[\"sale_qty\"]:\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t_(\n\t\t\t\t\t\t\"Sell quantity cannot exceed the asset quantity. Asset {0} has only {1} item(s).\"\n\t\t\t\t\t).format(asset, qty[\"actual_qty\"])\n\t\t\t\t)\n\n\t\t\tremaining_qty = qty[\"actual_qty\"] - qty[\"sale_qty\"]\n\t\t\tif remaining_qty > 0:\n\t\t\t\tsplit_asset(asset, remaining_qty)\n\n\tdef get_asset_qty(self):\n\t\tasset_qty_map = {}\n\n\t\tassets = {row.asset for row in self.items if row.is_fixed_asset and row.asset}\n\t\tif not assets or self.is_return:\n\t\t\treturn asset_qty_map\n\n\t\tasset_actual_qty = dict(\n\t\t\tfrappe.db.get_all(\n\t\t\t\t\"Asset\",\n\t\t\t\t{\"name\": [\"in\", list(assets)]},\n\t\t\t\t[\"name\", \"asset_quantity\"],\n\t\t\t\tas_list=True,\n\t\t\t)\n\t\t)\n\t\tfor row in self.items:\n\t\t\tif row.is_fixed_asset and row.asset:\n\t\t\t\tactual_qty = asset_actual_qty.get(row.asset)\n\t\t\t\tif row.asset in asset_qty_map.keys():\n\t\t\t\t\tasset_qty_map[row.asset][\"sale_qty\"] += flt(row.qty)\n\t\t\t\telse:\n\t\t\t\t\tasset_qty_map.setdefault(\n\t\t\t\t\t\trow.asset,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"sale_qty\": flt(row.qty),\n\t\t\t\t\t\t\t\"actual_qty\": flt(actual_qty),\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\n\t\treturn asset_qty_map\n\n\tdef process_asset_depreciation(self):\n\t\tif (self.is_return and self.docstatus == 2) or (not self.is_return and self.docstatus == 1):\n\t\t\tself.depreciate_asset_on_sale()\n\t\telse:\n\t\t\tself.restore_asset()\n\n\t\tself.update_asset()\n\n\tdef depreciate_asset_on_sale(self):\n\t\t\"\"\"\n\t\tDepreciate asset on sale or cancellation of return sales invoice\n\t\t\"\"\"\n\t\tdisposal_date = self.get_disposal_date()\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.asset:\n\t\t\t\tasset = frappe.get_doc(\"Asset\", d.asset)\n\t\t\t\tif asset.calculate_depreciation and asset.status != \"Fully Depreciated\":\n\t\t\t\t\tdepreciate_asset(asset, disposal_date, self.get_note_for_asset_sale(asset))\n\n\tdef get_note_for_asset_sale(self, asset):\n\t\treturn _(\"This schedule was created when Asset {0} was {1} through Sales Invoice {2}.\").format(\n\t\t\tget_link_to_form(asset.doctype, asset.name),\n\t\t\t_(\"returned\") if self.is_return else _(\"sold\"),\n\t\t\tget_link_to_form(self.doctype, self.get(\"name\")),\n\t\t)\n\n\tdef restore_asset(self):\n\t\t\"\"\"\n\t\tRestore asset on return or cancellation of original sales invoice\n\t\t\"\"\"\n\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.asset:\n\t\t\t\tasset = frappe.get_cached_doc(\"Asset\", d.asset)\n\t\t\t\tif asset.calculate_depreciation:\n\t\t\t\t\treverse_depreciation_entry_made_on_disposal(asset)\n\n\t\t\t\t\tnote = self.get_note_for_asset_return(asset)\n\t\t\t\t\treset_depreciation_schedule(asset, note)\n\n\tdef get_note_for_asset_return(self, asset):\n\t\tasset_link = get_link_to_form(asset.doctype, asset.name)\n\t\tinvoice_link = get_link_to_form(self.doctype, self.get(\"name\"))\n\t\tif self.is_return:\n\t\t\treturn _(\n\t\t\t\t\"This schedule was created when Asset {0} was returned through Sales Invoice {1}.\"\n\t\t\t).format(asset_link, invoice_link)\n\t\telse:\n\t\t\treturn _(\n\t\t\t\t\"This schedule was created when Asset {0} was restored due to Sales Invoice {1} cancellation.\"\n\t\t\t).format(asset_link, invoice_link)\n\n\tdef update_asset(self):\n\t\t\"\"\"\n\t\tUpdate asset status, disposal date and asset activity on sale or return sales invoice\n\t\t\"\"\"\n\n\t\tdef _update_asset(asset, disposal_date, note, asset_status=None):\n\t\t\tfrappe.db.set_value(\"Asset\", d.asset, \"disposal_date\", disposal_date)\n\t\t\tadd_asset_activity(asset.name, note)\n\t\t\tasset.set_status(asset_status)\n\n\t\tdisposal_date = self.get_disposal_date()\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.asset:\n\t\t\t\tasset = frappe.get_cached_doc(\"Asset\", d.asset)\n\n\t\t\t\tif (self.is_return and self.docstatus == 1) or (not self.is_return and self.docstatus == 2):\n\t\t\t\t\tnote = _(\"Asset returned\") if self.is_return else _(\"Asset sold\")\n\t\t\t\t\tasset_status, disposal_date = None, None\n\t\t\t\telse:\n\t\t\t\t\tnote = _(\"Asset sold\") if not self.is_return else _(\"Return invoice of asset cancelled\")\n\t\t\t\t\tasset_status = \"Sold\"\n\n\t\t\t\t_update_asset(asset, disposal_date, note, asset_status)\n\n\tdef get_disposal_date(self):\n\t\tif self.is_return:\n\t\t\tdisposal_date = frappe.db.get_value(\"Sales Invoice\", self.return_against, \"posting_date\")\n\t\telse:\n\t\t\tdisposal_date = self.posting_date\n\n\t\treturn disposal_date\n\n\tdef make_gl_entries(self, gl_entries=None, from_repost=False):\n\t\tfrom erpnext.accounts.general_ledger import make_gl_entries, make_reverse_gl_entries\n\n\t\tauto_accounting_for_stock = erpnext.is_perpetual_inventory_enabled(self.company)\n\t\tif not gl_entries:\n\t\t\tgl_entries = self.get_gl_entries()\n\n\t\tif gl_entries:\n\t\t\t# if POS and amount is written off, updating outstanding amt after posting all gl entries\n\t\t\tupdate_outstanding = (\n\t\t\t\t\"No\"\n\t\t\t\tif (cint(self.is_pos) or self.write_off_account or cint(self.redeem_loyalty_points))\n\t\t\t\telse \"Yes\"\n\t\t\t)\n\n\t\t\tif self.docstatus == 1:\n\t\t\t\tmake_gl_entries(\n\t\t\t\t\tgl_entries,\n\t\t\t\t\tupdate_outstanding=update_outstanding,\n\t\t\t\t\tmerge_entries=False,\n\t\t\t\t\tfrom_repost=from_repost,\n\t\t\t\t)\n\n\t\t\t\tself.make_exchange_gain_loss_journal()\n\t\t\telif self.docstatus == 2:\n\t\t\t\tmake_reverse_gl_entries(voucher_type=self.doctype, voucher_no=self.name)\n\n\t\t\tif update_outstanding == \"No\":\n\t\t\t\tupdate_voucher_outstanding(\n\t\t\t\t\tvoucher_type=self.doctype,\n\t\t\t\t\tvoucher_no=self.return_against\n\t\t\t\t\tif cint(self.is_return) and self.return_against\n\t\t\t\t\telse self.name,\n\t\t\t\t\taccount=self.debit_to,\n\t\t\t\t\tparty_type=\"Customer\",\n\t\t\t\t\tparty=self.customer,\n\t\t\t\t)\n\n\t\telif self.docstatus == 2 and cint(self.update_stock) and cint(auto_accounting_for_stock):\n\t\t\tmake_reverse_gl_entries(voucher_type=self.doctype, voucher_no=self.name)\n\n\tdef get_gl_entries(self, inventory_account_map=None):\n\t\tfrom erpnext.accounts.general_ledger import merge_similar_entries\n\n\t\tgl_entries = []\n\n\t\tself.make_customer_gl_entry(gl_entries)\n\n\t\tself.make_tax_gl_entries(gl_entries)\n\t\tself.make_internal_transfer_gl_entries(gl_entries)\n\n\t\tself.make_item_gl_entries(gl_entries)\n\t\tself.make_precision_loss_gl_entry(gl_entries)\n\t\tself.make_discount_gl_entries(gl_entries)\n\n\t\tgl_entries = make_regional_gl_entries(gl_entries, self)\n\n\t\t# merge gl entries before adding pos entries\n\t\tgl_entries = merge_similar_entries(gl_entries)\n\n\t\tself.make_loyalty_point_redemption_gle(gl_entries)\n\t\tself.make_pos_gl_entries(gl_entries)\n\n\t\tself.make_write_off_gl_entry(gl_entries)\n\t\tself.make_gle_for_rounding_adjustment(gl_entries)\n\n\t\tself.set_transaction_currency_and_rate_in_gl_map(gl_entries)\n\t\treturn gl_entries\n\n\tdef make_customer_gl_entry(self, gl_entries):\n\t\t# Checked both rounding_adjustment and rounded_total\n\t\t# because rounded_total had value even before introduction of posting GLE based on rounded total\n\t\tgrand_total = (\n\t\t\tself.rounded_total if (self.rounding_adjustment and self.rounded_total) else self.grand_total\n\t\t)\n\t\tbase_grand_total = flt(\n\t\t\tself.base_rounded_total\n\t\t\tif (self.base_rounding_adjustment and self.base_rounded_total)\n\t\t\telse self.base_grand_total,\n\t\t\tself.precision(\"base_grand_total\"),\n\t\t)\n\n\t\tif grand_total and not self.is_internal_transfer():\n\t\t\tagainst_voucher = self.name\n\t\t\tif self.is_return and self.return_against and not self.update_outstanding_for_self:\n\t\t\t\tagainst_voucher = self.return_against\n\n\t\t\t# Did not use base_grand_total to book rounding loss gle\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.debit_to,\n\t\t\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\t\t\"party\": self.customer,\n\t\t\t\t\t\t\"due_date\": self.due_date,\n\t\t\t\t\t\t\"against\": self.against_income_account,\n\t\t\t\t\t\t\"debit\": base_grand_total,\n\t\t\t\t\t\t\"debit_in_account_currency\": base_grand_total\n\t\t\t\t\t\tif self.party_account_currency == self.company_currency\n\t\t\t\t\t\telse grand_total,\n\t\t\t\t\t\t\"debit_in_transaction_currency\": grand_total,\n\t\t\t\t\t\t\"against_voucher\": against_voucher,\n\t\t\t\t\t\t\"against_voucher_type\": self.doctype,\n\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t\t\"project\": self.project,\n\t\t\t\t\t},\n\t\t\t\t\tself.party_account_currency,\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\n\tdef make_tax_gl_entries(self, gl_entries):\n\t\tenable_discount_accounting = cint(\n\t\t\tfrappe.get_single_value(\"Selling Settings\", \"enable_discount_accounting\")\n\t\t)\n\n\t\tfor tax in self.get(\"taxes\"):\n\t\t\tamount, base_amount = self.get_tax_amounts(tax, enable_discount_accounting)\n\n\t\t\tif flt(tax.base_tax_amount_after_discount_amount):\n\t\t\t\taccount_currency = get_account_currency(tax.account_head)\n\t\t\t\tgl_entries.append(\n\t\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"account\": tax.account_head,\n\t\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\t\"credit\": flt(base_amount, tax.precision(\"tax_amount_after_discount_amount\")),\n\t\t\t\t\t\t\t\"credit_in_account_currency\": (\n\t\t\t\t\t\t\t\tflt(base_amount, tax.precision(\"base_tax_amount_after_discount_amount\"))\n\t\t\t\t\t\t\t\tif account_currency == self.company_currency\n\t\t\t\t\t\t\t\telse flt(amount, tax.precision(\"tax_amount_after_discount_amount\"))\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\"credit_in_transaction_currency\": flt(\n\t\t\t\t\t\t\t\tamount, tax.precision(\"tax_amount_after_discount_amount\")\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\"cost_center\": tax.cost_center,\n\t\t\t\t\t\t},\n\t\t\t\t\t\taccount_currency,\n\t\t\t\t\t\titem=tax,\n\t\t\t\t\t)\n\t\t\t\t)\n\n\tdef make_internal_transfer_gl_entries(self, gl_entries):\n\t\tif self.is_internal_transfer() and flt(self.base_total_taxes_and_charges):\n\t\t\taccount_currency = get_account_currency(self.unrealized_profit_loss_account)\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.unrealized_profit_loss_account,\n\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\"debit\": flt(self.total_taxes_and_charges),\n\t\t\t\t\t\t\"debit_in_account_currency\": flt(self.base_total_taxes_and_charges),\n\t\t\t\t\t\t\"debit_in_transaction_currency\": flt(self.total_taxes_and_charges),\n\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t},\n\t\t\t\t\taccount_currency,\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\n\tdef make_item_gl_entries(self, gl_entries):\n\t\t# income account gl entries\n\t\tenable_discount_accounting = cint(\n\t\t\tfrappe.get_single_value(\"Selling Settings\", \"enable_discount_accounting\")\n\t\t)\n\n\t\tfor item in self.get(\"items\"):\n\t\t\tif (\n\t\t\t\tflt(item.base_net_amount, item.precision(\"base_net_amount\"))\n\t\t\t\tor item.is_fixed_asset\n\t\t\t\tor enable_discount_accounting\n\t\t\t):\n\t\t\t\t# Do not book income for transfer within same company\n\t\t\t\tif self.is_internal_transfer():\n\t\t\t\t\tcontinue\n\n\t\t\t\tif item.is_fixed_asset and item.asset:\n\t\t\t\t\tself.get_gl_entries_for_fixed_asset(item, gl_entries)\n\t\t\t\telse:\n\t\t\t\t\tincome_account = (\n\t\t\t\t\t\titem.income_account\n\t\t\t\t\t\tif (not item.enable_deferred_revenue or self.is_return)\n\t\t\t\t\t\telse item.deferred_revenue_account\n\t\t\t\t\t)\n\n\t\t\t\t\tamount, base_amount = self.get_amount_and_base_amount(item, enable_discount_accounting)\n\n\t\t\t\t\taccount_currency = get_account_currency(income_account)\n\t\t\t\t\tgl_entries.append(\n\t\t\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"account\": income_account,\n\t\t\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\t\t\"credit\": flt(base_amount, item.precision(\"base_net_amount\")),\n\t\t\t\t\t\t\t\t\"credit_in_account_currency\": (\n\t\t\t\t\t\t\t\t\tflt(base_amount, item.precision(\"base_net_amount\"))\n\t\t\t\t\t\t\t\t\tif account_currency == self.company_currency\n\t\t\t\t\t\t\t\t\telse flt(amount, item.precision(\"net_amount\"))\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\"credit_in_transaction_currency\": flt(amount, item.precision(\"net_amount\")),\n\t\t\t\t\t\t\t\t\"cost_center\": item.cost_center,\n\t\t\t\t\t\t\t\t\"project\": item.project or self.project,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\taccount_currency,\n\t\t\t\t\t\t\titem=item,\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\t\t# expense account gl entries\n\t\tif cint(self.update_stock) and erpnext.is_perpetual_inventory_enabled(self.company):\n\t\t\tgl_entries += super().get_gl_entries()\n\n\tdef get_gl_entries_for_fixed_asset(self, item, gl_entries):\n\t\tasset = frappe.get_cached_doc(\"Asset\", item.asset)\n\n\t\tif self.is_return:\n\t\t\tfixed_asset_gl_entries = get_gl_entries_on_asset_regain(\n\t\t\t\tasset,\n\t\t\t\titem.base_net_amount,\n\t\t\t\titem.finance_book,\n\t\t\t\tself.get(\"doctype\"),\n\t\t\t\tself.get(\"name\"),\n\t\t\t\tself.get(\"posting_date\"),\n\t\t\t)\n\t\telse:\n\t\t\tfixed_asset_gl_entries = get_gl_entries_on_asset_disposal(\n\t\t\t\tasset,\n\t\t\t\titem.base_net_amount,\n\t\t\t\titem.finance_book,\n\t\t\t\tself.get(\"doctype\"),\n\t\t\t\tself.get(\"name\"),\n\t\t\t\tself.get(\"posting_date\"),\n\t\t\t)\n\n\t\tfor gle in fixed_asset_gl_entries:\n\t\t\tgle[\"against\"] = self.customer\n\t\t\tgl_entries.append(self.get_gl_dict(gle, item=item))\n\n\t@property\n\tdef enable_discount_accounting(self):\n\t\tif not hasattr(self, \"_enable_discount_accounting\"):\n\t\t\tself._enable_discount_accounting = cint(\n\t\t\t\tfrappe.get_single_value(\"Selling Settings\", \"enable_discount_accounting\")\n\t\t\t)\n\n\t\treturn self._enable_discount_accounting\n\n\tdef make_loyalty_point_redemption_gle(self, gl_entries):\n\t\tif cint(self.redeem_loyalty_points and self.loyalty_points and not self.is_consolidated):\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.debit_to,\n\t\t\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\t\t\"party\": self.customer,\n\t\t\t\t\t\t\"against\": \"Expense account - \"\n\t\t\t\t\t\t+ cstr(self.loyalty_redemption_account)\n\t\t\t\t\t\t+ \" for the Loyalty Program\",\n\t\t\t\t\t\t\"credit\": self.loyalty_amount,\n\t\t\t\t\t\t\"credit_in_transaction_currency\": self.loyalty_amount,\n\t\t\t\t\t\t\"against_voucher\": self.return_against if cint(self.is_return) else self.name,\n\t\t\t\t\t\t\"against_voucher_type\": self.doctype,\n\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t},\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.loyalty_redemption_account,\n\t\t\t\t\t\t\"cost_center\": self.cost_center or self.loyalty_redemption_cost_center,\n\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\"debit\": self.loyalty_amount,\n\t\t\t\t\t\t\"debit_in_transaction_currency\": self.loyalty_amount,\n\t\t\t\t\t\t\"remark\": \"Loyalty Points redeemed by the customer\",\n\t\t\t\t\t},\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\n\tdef make_pos_gl_entries(self, gl_entries):\n\t\tif cint(self.is_pos):\n\t\t\tskip_change_gl_entries = not cint(\n\t\t\t\tfrappe.get_single_value(\"POS Settings\", \"post_change_gl_entries\")\n\t\t\t)\n\n\t\t\tfor payment_mode in self.payments:\n\t\t\t\tif skip_change_gl_entries and payment_mode.account == self.account_for_change_amount:\n\t\t\t\t\tpayment_mode.base_amount -= flt(self.change_amount)\n\n\t\t\t\tagainst_voucher = self.name\n\t\t\t\tif self.is_return and self.return_against and not self.update_outstanding_for_self:\n\t\t\t\t\tagainst_voucher = self.return_against\n\n\t\t\t\tif payment_mode.base_amount:\n\t\t\t\t\t# POS, make payment entries\n\t\t\t\t\tgl_entries.append(\n\t\t\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"account\": self.debit_to,\n\t\t\t\t\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\t\t\t\t\"party\": self.customer,\n\t\t\t\t\t\t\t\t\"against\": payment_mode.account,\n\t\t\t\t\t\t\t\t\"credit\": payment_mode.base_amount,\n\t\t\t\t\t\t\t\t\"credit_in_account_currency\": payment_mode.base_amount\n\t\t\t\t\t\t\t\tif self.party_account_currency == self.company_currency\n\t\t\t\t\t\t\t\telse payment_mode.amount,\n\t\t\t\t\t\t\t\t\"credit_in_transaction_currency\": payment_mode.amount,\n\t\t\t\t\t\t\t\t\"against_voucher\": against_voucher,\n\t\t\t\t\t\t\t\t\"against_voucher_type\": self.doctype,\n\t\t\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tself.party_account_currency,\n\t\t\t\t\t\t\titem=self,\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\t\t\t\t\tpayment_mode_account_currency = get_account_currency(payment_mode.account)\n\t\t\t\t\tgl_entries.append(\n\t\t\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"account\": payment_mode.account,\n\t\t\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\t\t\"debit\": payment_mode.base_amount,\n\t\t\t\t\t\t\t\t\"debit_in_account_currency\": payment_mode.base_amount\n\t\t\t\t\t\t\t\tif payment_mode_account_currency == self.company_currency\n\t\t\t\t\t\t\t\telse payment_mode.amount,\n\t\t\t\t\t\t\t\t\"debit_in_transaction_currency\": payment_mode.amount,\n\t\t\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tpayment_mode_account_currency,\n\t\t\t\t\t\t\titem=self,\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\n\t\t\tif not skip_change_gl_entries:\n\t\t\t\tgl_entries.extend(self.get_gle_for_change_amount())\n\n\tdef get_gle_for_change_amount(self) -> list[dict]:\n\t\tif not self.change_amount:\n\t\t\treturn []\n\n\t\tif not self.account_for_change_amount:\n\t\t\tfrappe.throw(_(\"Please set Account for Change Amount\"), title=_(\"Mandatory Field\"))\n\n\t\treturn [\n\t\t\tself.get_gl_dict(\n\t\t\t\t{\n\t\t\t\t\t\"account\": self.debit_to,\n\t\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\t\"party\": self.customer,\n\t\t\t\t\t\"against\": self.account_for_change_amount,\n\t\t\t\t\t\"debit\": flt(self.base_change_amount),\n\t\t\t\t\t\"debit_in_account_currency\": flt(self.base_change_amount)\n\t\t\t\t\tif self.party_account_currency == self.company_currency\n\t\t\t\t\telse flt(self.change_amount),\n\t\t\t\t\t\"debit_in_transaction_currency\": flt(self.change_amount),\n\t\t\t\t\t\"against_voucher\": self.return_against\n\t\t\t\t\tif cint(self.is_return) and self.return_against\n\t\t\t\t\telse self.name,\n\t\t\t\t\t\"against_voucher_type\": self.doctype,\n\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t\"project\": self.project,\n\t\t\t\t},\n\t\t\t\tself.party_account_currency,\n\t\t\t\titem=self,\n\t\t\t),\n\t\t\tself.get_gl_dict(\n\t\t\t\t{\n\t\t\t\t\t\"account\": self.account_for_change_amount,\n\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\"credit\": self.base_change_amount,\n\t\t\t\t\t\"credit_in_transaction_currency\": self.change_amount,\n\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t},\n\t\t\t\titem=self,\n\t\t\t),\n\t\t]\n\n\tdef make_write_off_gl_entry(self, gl_entries):\n\t\t# write off entries, applicable if only pos\n\t\tif (\n\t\t\tself.is_pos\n\t\t\tand self.write_off_account\n\t\t\tand flt(self.write_off_amount, self.precision(\"write_off_amount\"))\n\t\t):\n\t\t\twrite_off_account_currency = get_account_currency(self.write_off_account)\n\t\t\tdefault_cost_center = frappe.get_cached_value(\"Company\", self.company, \"cost_center\")\n\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.debit_to,\n\t\t\t\t\t\t\"party_type\": \"Customer\",\n\t\t\t\t\t\t\"party\": self.customer,\n\t\t\t\t\t\t\"against\": self.write_off_account,\n\t\t\t\t\t\t\"credit\": flt(self.base_write_off_amount, self.precision(\"base_write_off_amount\")),\n\t\t\t\t\t\t\"credit_in_account_currency\": (\n\t\t\t\t\t\t\tflt(self.base_write_off_amount, self.precision(\"base_write_off_amount\"))\n\t\t\t\t\t\t\tif self.party_account_currency == self.company_currency\n\t\t\t\t\t\t\telse flt(self.write_off_amount, self.precision(\"write_off_amount\"))\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"credit_in_transaction_currency\": flt(\n\t\t\t\t\t\t\tself.write_off_amount, self.precision(\"write_off_amount\")\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"against_voucher\": self.return_against if cint(self.is_return) else self.name,\n\t\t\t\t\t\t\"against_voucher_type\": self.doctype,\n\t\t\t\t\t\t\"cost_center\": self.cost_center,\n\t\t\t\t\t\t\"project\": self.project,\n\t\t\t\t\t},\n\t\t\t\t\tself.party_account_currency,\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": self.write_off_account,\n\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\"debit\": flt(self.base_write_off_amount, self.precision(\"base_write_off_amount\")),\n\t\t\t\t\t\t\"debit_in_account_currency\": (\n\t\t\t\t\t\t\tflt(self.base_write_off_amount, self.precision(\"base_write_off_amount\"))\n\t\t\t\t\t\t\tif write_off_account_currency == self.company_currency\n\t\t\t\t\t\t\telse flt(self.write_off_amount, self.precision(\"write_off_amount\"))\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"debit_in_transaction_currency\": flt(\n\t\t\t\t\t\t\tself.write_off_amount, self.precision(\"write_off_amount\")\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"cost_center\": self.cost_center or self.write_off_cost_center or default_cost_center,\n\t\t\t\t\t},\n\t\t\t\t\twrite_off_account_currency,\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\n\tdef make_gle_for_rounding_adjustment(self, gl_entries):\n\t\tif (\n\t\t\tflt(self.rounding_adjustment, self.precision(\"rounding_adjustment\"))\n\t\t\tand self.base_rounding_adjustment\n\t\t\tand not self.is_internal_transfer()\n\t\t):\n\t\t\t(\n\t\t\t\tround_off_account,\n\t\t\t\tround_off_cost_center,\n\t\t\t\tround_off_for_opening,\n\t\t\t) = get_round_off_account_and_cost_center(\n\t\t\t\tself.company, \"Sales Invoice\", self.name, self.use_company_roundoff_cost_center\n\t\t\t)\n\n\t\t\tif self.is_opening == \"Yes\" and self.rounding_adjustment:\n\t\t\t\tif not round_off_for_opening:\n\t\t\t\t\tfrappe.throw(\n\t\t\t\t\t\t_(\n\t\t\t\t\t\t\t\"Opening Invoice has rounding adjustment of {0}.<br><br> '{1}' account is required to post these values. Please set it in Company: {2}.<br><br> Or, '{3}' can be enabled to not post any rounding adjustment.\"\n\t\t\t\t\t\t).format(\n\t\t\t\t\t\t\tfrappe.bold(self.rounding_adjustment),\n\t\t\t\t\t\t\tfrappe.bold(\"Round Off for Opening\"),\n\t\t\t\t\t\t\tget_link_to_form(\"Company\", self.company),\n\t\t\t\t\t\t\tfrappe.bold(\"Disable Rounded Total\"),\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\telse:\n\t\t\t\t\tround_off_account = round_off_for_opening\n\n\t\t\tgl_entries.append(\n\t\t\t\tself.get_gl_dict(\n\t\t\t\t\t{\n\t\t\t\t\t\t\"account\": round_off_account,\n\t\t\t\t\t\t\"against\": self.customer,\n\t\t\t\t\t\t\"credit_in_account_currency\": flt(\n\t\t\t\t\t\t\tself.rounding_adjustment, self.precision(\"rounding_adjustment\")\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"credit_in_transaction_currency\": flt(\n\t\t\t\t\t\t\tself.rounding_adjustment, self.precision(\"rounding_adjustment\")\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"credit\": flt(\n\t\t\t\t\t\t\tself.base_rounding_adjustment, self.precision(\"base_rounding_adjustment\")\n\t\t\t\t\t\t),\n\t\t\t\t\t\t\"cost_center\": round_off_cost_center\n\t\t\t\t\t\tif self.use_company_roundoff_cost_center\n\t\t\t\t\t\telse (self.cost_center or round_off_cost_center),\n\t\t\t\t\t},\n\t\t\t\t\titem=self,\n\t\t\t\t)\n\t\t\t)\n\n\tdef update_billing_status_in_dn(self, update_modified=True):\n\t\tif self.is_return and not self.update_billed_amount_in_delivery_note:\n\t\t\treturn\n\t\tupdated_delivery_notes = []\n\t\tfor d in self.get(\"items\"):\n\t\t\tif d.dn_detail:\n\t\t\t\tbilled_amt = frappe.db.sql(\n\t\t\t\t\t\"\"\"select sum(amount) from `tabSales Invoice Item`\n\t\t\t\t\twhere dn_detail=%s and docstatus=1\"\"\",\n\t\t\t\t\td.dn_detail,\n\t\t\t\t)\n\t\t\t\tbilled_amt = billed_amt and billed_amt[0][0] or 0\n\t\t\t\tfrappe.db.set_value(\n\t\t\t\t\t\"Delivery Note Item\",\n\t\t\t\t\td.dn_detail,\n\t\t\t\t\t\"billed_amt\",\n\t\t\t\t\tbilled_amt,\n\t\t\t\t\tupdate_modified=update_modified,\n\t\t\t\t)\n\t\t\t\tupdated_delivery_notes.append(d.delivery_note)\n\t\t\telif d.so_detail:\n\t\t\t\tupdated_delivery_notes += update_billed_amount_based_on_so(d.so_detail, update_modified)\n\n\t\tfor dn in set(updated_delivery_notes):\n\t\t\tfrappe.get_doc(\"Delivery Note\", dn).update_billing_percentage(update_modified=update_modified)\n\n\tdef on_recurring(self, reference_doc, auto_repeat_doc):\n\t\tself.set(\"write_off_amount\", reference_doc.get(\"write_off_amount\"))\n\t\tself.due_date = None\n\n\tdef update_project(self):\n\t\tunique_projects = list(set([d.project for d in self.get(\"items\") if d.project]))\n\t\tif self.project and self.project not in unique_projects:\n\t\t\tunique_projects.append(self.project)\n\n\t\tfor p in unique_projects:\n\t\t\tproject = frappe.get_doc(\"Project\", p)\n\t\t\tproject.update_billed_amount()\n\t\t\tproject.calculate_gross_margin()\n\t\t\tproject.db_update()\n\n\tdef verify_payment_amount_is_positive(self):\n\t\tfor entry in self.payments:\n\t\t\tif entry.amount < 0:\n\t\t\t\tfrappe.throw(_(\"Row #{0} (Payment Table): Amount must be positive\").format(entry.idx))\n\n\tdef verify_payment_amount_is_negative(self):\n\t\tfor entry in self.payments:\n\t\t\tif entry.amount > 0:\n\t\t\t\tfrappe.throw(_(\"Row #{0} (Payment Table): Amount must be negative\").format(entry.idx))\n\n\t# collection of the loyalty points, create the ledger entry for that.\n\tdef make_loyalty_point_entry(self):\n\t\treturned_amount = self.get_returned_amount()\n\t\tcurrent_amount = flt(self.grand_total) - cint(self.loyalty_amount)\n\t\teligible_amount = current_amount - returned_amount\n\t\tlp_details = get_loyalty_program_details_with_points(\n\t\t\tself.customer,\n\t\t\tcompany=self.company,\n\t\t\tcurrent_transaction_amount=current_amount,\n\t\t\tloyalty_program=self.loyalty_program,\n\t\t\texpiry_date=self.posting_date,\n\t\t\tinclude_expired_entry=True,\n\t\t)\n\t\tif (\n\t\t\tlp_details\n\t\t\tand getdate(lp_details.from_date) <= getdate(self.posting_date)\n\t\t\tand (not lp_details.to_date or getdate(lp_details.to_date) >= getdate(self.posting_date))\n\t\t):\n\t\t\tcollection_factor = lp_details.collection_factor if lp_details.collection_factor else 1.0\n\t\t\tpoints_earned = cint(eligible_amount / collection_factor)\n\n\t\t\tdoc = frappe.get_doc(\n\t\t\t\t{\n\t\t\t\t\t\"doctype\": \"Loyalty Point Entry\",\n\t\t\t\t\t\"company\": self.company,\n\t\t\t\t\t\"loyalty_program\": lp_details.loyalty_program,\n\t\t\t\t\t\"loyalty_program_tier\": lp_details.tier_name,\n\t\t\t\t\t\"customer\": self.customer,\n\t\t\t\t\t\"invoice_type\": self.doctype,\n\t\t\t\t\t\"invoice\": self.name,\n\t\t\t\t\t\"loyalty_points\": points_earned,\n\t\t\t\t\t\"purchase_amount\": eligible_amount,\n\t\t\t\t\t\"expiry_date\": add_days(self.posting_date, lp_details.expiry_duration),\n\t\t\t\t\t\"posting_date\": self.posting_date,\n\t\t\t\t}\n\t\t\t)\n\t\t\tdoc.flags.ignore_permissions = 1\n\t\t\tdoc.save()\n\t\t\tself.set_loyalty_program_tier()\n\n\t# valdite the redemption and then delete the loyalty points earned on cancel of the invoice\n\tdef delete_loyalty_point_entry(self):\n\t\tlp_entry = frappe.db.sql(\n\t\t\t\"select name from `tabLoyalty Point Entry` where invoice=%s\", (self.name), as_dict=1\n\t\t)\n\n\t\tif not lp_entry:\n\t\t\treturn\n\t\tagainst_lp_entry = frappe.db.sql(\n\t\t\t\"\"\"select name, invoice from `tabLoyalty Point Entry`\n\t\t\twhere redeem_against=%s\"\"\",\n\t\t\t(lp_entry[0].name),\n\t\t\tas_dict=1,\n\t\t)\n\t\tif against_lp_entry:\n\t\t\tinvoice_list = \", \".join([d.invoice for d in against_lp_entry])\n\t\t\tfrappe.throw(\n\t\t\t\t_(\n\t\t\t\t\t\"\"\"{} can't be cancelled since the Loyalty Points earned has been redeemed. First cancel the {} No {}\"\"\"\n\t\t\t\t).format(self.doctype, self.doctype, invoice_list)\n\t\t\t)\n\t\telse:\n\t\t\tfrappe.db.sql(\"\"\"delete from `tabLoyalty Point Entry` where invoice=%s\"\"\", (self.name))\n\t\t\t# Set loyalty program\n\t\t\tself.set_loyalty_program_tier()\n\n\tdef set_loyalty_program_tier(self):\n\t\tlp_details = get_loyalty_program_details_with_points(\n\t\t\tself.customer,\n\t\t\tcompany=self.company,\n\t\t\tloyalty_program=self.loyalty_program,\n\t\t\tinclude_expired_entry=True,\n\t\t)\n\t\tcustomer = frappe.get_doc(\"Customer\", self.customer)\n\t\tcustomer.db_set(\"loyalty_program_tier\", lp_details.tier_name)\n\n\tdef get_returned_amount(self):\n\t\tfrom frappe.query_builder.functions import Sum\n\n\t\tdoc = frappe.qb.DocType(self.doctype)\n\t\treturned_amount = (\n\t\t\tfrappe.qb.from_(doc)\n\t\t\t.select(Sum(doc.grand_total))\n\t\t\t.where((doc.docstatus == 1) & (doc.is_return == 1) & (doc.return_against == self.name))\n\t\t).run()\n\n\t\treturn abs(returned_amount[0][0]) if returned_amount[0][0] else 0\n\n\t# redeem the loyalty points.\n\tdef apply_loyalty_points(self):\n\t\tfrom erpnext.accounts.doctype.loyalty_point_entry.loyalty_point_entry import (\n\t\t\tget_loyalty_point_entries,\n\t\t\tget_redemption_details,\n\t\t)\n\n\t\tloyalty_point_entries = get_loyalty_point_entries(\n\t\t\tself.customer, self.loyalty_program, self.company, self.posting_date\n\t\t)\n\t\tredemption_details = get_redemption_details(self.customer, self.loyalty_program, self.company)\n\n\t\tpoints_to_redeem = self.loyalty_points\n\t\tfor lp_entry in loyalty_point_entries:\n\t\t\tif lp_entry.invoice_type != self.doctype or lp_entry.invoice == self.name:\n\t\t\t\t# redeemption should be done against same doctype\n\t\t\t\t# also it shouldn't be against itself\n\t\t\t\tcontinue\n\t\t\tavailable_points = lp_entry.loyalty_points - flt(redemption_details.get(lp_entry.name))\n\t\t\tif available_points > points_to_redeem:\n\t\t\t\tredeemed_points = points_to_redeem\n\t\t\telse:\n\t\t\t\tredeemed_points = available_points\n\t\t\tdoc = frappe.get_doc(\n\t\t\t\t{\n\t\t\t\t\t\"doctype\": \"Loyalty Point Entry\",\n\t\t\t\t\t\"company\": self.company,\n\t\t\t\t\t\"loyalty_program\": self.loyalty_program,\n\t\t\t\t\t\"loyalty_program_tier\": lp_entry.loyalty_program_tier,\n\t\t\t\t\t\"customer\": self.customer,\n\t\t\t\t\t\"invoice_type\": self.doctype,\n\t\t\t\t\t\"invoice\": self.name,\n\t\t\t\t\t\"redeem_against\": lp_entry.name,\n\t\t\t\t\t\"loyalty_points\": -1 * redeemed_points,\n\t\t\t\t\t\"purchase_amount\": self.grand_total,\n\t\t\t\t\t\"expiry_date\": lp_entry.expiry_date,\n\t\t\t\t\t\"posting_date\": self.posting_date,\n\t\t\t\t}\n\t\t\t)\n\t\t\tdoc.flags.ignore_permissions = 1\n\t\t\tdoc.save()\n\t\t\tpoints_to_redeem -= redeemed_points\n\t\t\tif points_to_redeem < 1:  # since points_to_redeem is integer\n\t\t\t\tbreak\n\n\tdef set_status(self, update=False, status=None, update_modified=True):\n\t\tif self.is_new():\n\t\t\tif self.get(\"amended_from\"):\n\t\t\t\tself.status = \"Draft\"\n\t\t\treturn\n\n\t\toutstanding_amount = flt(self.outstanding_amount, self.precision(\"outstanding_amount\"))\n\t\ttotal = get_total_in_party_account_currency(self)\n\n\t\tif not status:\n\t\t\tif self.docstatus == 2:\n\t\t\t\tstatus = \"Cancelled\"\n\t\t\telif self.docstatus == 1:\n\t\t\t\tif self.is_internal_transfer():\n\t\t\t\t\tself.status = \"Internal Transfer\"\n\t\t\t\telif is_overdue(self, total):\n\t\t\t\t\tself.status = \"Overdue\"\n\t\t\t\telif 0 < outstanding_amount < total:\n\t\t\t\t\tself.status = \"Partly Paid\"\n\t\t\t\telif outstanding_amount > 0 and getdate(self.due_date) >= getdate():\n\t\t\t\t\tself.status = \"Unpaid\"\n\t\t\t\t# Check if outstanding amount is 0 due to credit note issued against invoice\n\t\t\t\telif self.is_return == 0 and frappe.db.get_value(\n\t\t\t\t\t\"Sales Invoice\", {\"is_return\": 1, \"return_against\": self.name, \"docstatus\": 1}\n\t\t\t\t):\n\t\t\t\t\tself.status = \"Credit Note Issued\"\n\t\t\t\telif self.is_return == 1:\n\t\t\t\t\tself.status = \"Return\"\n\t\t\t\telif outstanding_amount <= 0:\n\t\t\t\t\tself.status = \"Paid\"\n\t\t\t\telse:\n\t\t\t\t\tself.status = \"Submitted\"\n\n\t\t\t\tif (\n\t\t\t\t\tself.status in (\"Unpaid\", \"Partly Paid\", \"Overdue\")\n\t\t\t\t\tand self.is_discounted\n\t\t\t\t\tand get_discounting_status(self.name) == \"Disbursed\"\n\t\t\t\t):\n\t\t\t\t\tself.status += \" and Discounted\"\n\n\t\t\telse:\n\t\t\t\tself.status = \"Draft\"\n\n\t\tif update:\n\t\t\tself.db_set(\"status\", self.status, update_modified=update_modified)\n\n\t@frappe.whitelist()\n\tdef is_subcontracted(self):\n\t\tif not self.has_subcontracted:\n\t\t\tself.has_subcontracted = bool(\n\t\t\t\tfrappe.get_cached_value(\n\t\t\t\t\t\"Sales Order\",\n\t\t\t\t\t{\n\t\t\t\t\t\t\"name\": [\"in\", [item.sales_order for item in self.items if item.sales_order]],\n\t\t\t\t\t\t\"is_subcontracted\": 1,\n\t\t\t\t\t},\n\t\t\t\t\t\"name\",\n\t\t\t\t)\n\t\t\t)\n\t\tif self.has_subcontracted:\n\t\t\tself.update_stock = 0\n\t\treturn self.has_subcontracted\n\n\ndef get_total_in_party_account_currency(doc):\n\ttotal_fieldname = \"grand_total\" if doc.disable_rounded_total else \"rounded_total\"\n\tif doc.party_account_currency != doc.currency:\n\t\ttotal_fieldname = \"base_\" + total_fieldname\n\n\treturn flt(doc.get(total_fieldname), doc.precision(total_fieldname))\n\n\ndef is_overdue(doc, total):\n\toutstanding_amount = flt(doc.outstanding_amount, doc.precision(\"outstanding_amount\"))\n\tif outstanding_amount <= 0:\n\t\treturn\n\n\ttoday = getdate()\n\tif doc.get(\"is_pos\") or not doc.get(\"payment_schedule\"):\n\t\treturn getdate(doc.due_date) < today\n\n\t# calculate payable amount till date\n\tpayment_amount_field = (\n\t\t\"base_payment_amount\" if doc.party_account_currency != doc.currency else \"payment_amount\"\n\t)\n\n\tpayable_amount = flt(\n\t\tsum(\n\t\t\tpayment.get(payment_amount_field)\n\t\t\tfor payment in doc.payment_schedule\n\t\t\tif getdate(payment.due_date) < today\n\t\t),\n\t\tdoc.precision(\"outstanding_amount\"),\n\t)\n\n\treturn flt(total - outstanding_amount, doc.precision(\"outstanding_amount\")) < payable_amount\n\n\ndef get_discounting_status(sales_invoice):\n\tstatus = None\n\n\tinvoice_discounting_list = frappe.db.sql(\n\t\t\"\"\"\n\t\tselect status\n\t\tfrom `tabInvoice Discounting` id, `tabDiscounted Invoice` d\n\t\twhere\n\t\t\tid.name = d.parent\n\t\t\tand d.sales_invoice=%s\n\t\t\tand id.docstatus=1\n\t\t\tand status in ('Disbursed', 'Settled')\n\t\"\"\",\n\t\tsales_invoice,\n\t)\n\n\tfor d in invoice_discounting_list:\n\t\tstatus = d[0]\n\t\tif status == \"Disbursed\":\n\t\t\tbreak\n\n\treturn status\n\n\ndef validate_inter_company_party(doctype, party, company, inter_company_reference):\n\tif not party:\n\t\treturn\n\n\tif doctype in [\"Sales Invoice\", \"Sales Order\"]:\n\t\tpartytype, ref_partytype, internal = \"Customer\", \"Supplier\", \"is_internal_customer\"\n\n\t\tif doctype == \"Sales Invoice\":\n\t\t\tref_doc = \"Purchase Invoice\"\n\t\telse:\n\t\t\tref_doc = \"Purchase Order\"\n\telse:\n\t\tpartytype, ref_partytype, internal = \"Supplier\", \"Customer\", \"is_internal_supplier\"\n\n\t\tif doctype == \"Purchase Invoice\":\n\t\t\tref_doc = \"Sales Invoice\"\n\t\telse:\n\t\t\tref_doc = \"Sales Order\"\n\n\tif inter_company_reference:\n\t\tdoc = frappe.get_doc(ref_doc, inter_company_reference)\n\t\tref_party = doc.supplier if doctype in [\"Sales Invoice\", \"Sales Order\"] else doc.customer\n\t\tif frappe.db.get_value(partytype, {\"represents_company\": doc.company}, \"name\") != party:\n\t\t\tfrappe.throw(_(\"Invalid {0} for Inter Company Transaction.\").format(_(partytype)))\n\t\tif frappe.get_cached_value(ref_partytype, ref_party, \"represents_company\") != company:\n\t\t\tfrappe.throw(_(\"Invalid Company for Inter Company Transaction.\"))\n\n\telif frappe.db.get_value(partytype, {\"name\": party, internal: 1}, \"name\") == party:\n\t\tcompanies = frappe.get_all(\n\t\t\t\"Allowed To Transact With\",\n\t\t\tfields=[\"company\"],\n\t\t\tfilters={\"parenttype\": partytype, \"parent\": party},\n\t\t)\n\t\tcompanies = [d.company for d in companies]\n\t\tif company not in companies:\n\t\t\tfrappe.throw(\n\t\t\t\t_(\n\t\t\t\t\t\"{0} not allowed to transact with {1}. Please change the Company or add the Company in the 'Allowed To Transact With'-Section in the Customer record.\"\n\t\t\t\t).format(_(partytype), company)\n\t\t\t)\n\n\ndef update_linked_doc(doctype, name, inter_company_reference):\n\tif doctype in [\"Sales Invoice\", \"Purchase Invoice\"]:\n\t\tref_field = \"inter_company_invoice_reference\"\n\telse:\n\t\tref_field = \"inter_company_order_reference\"\n\n\tif inter_company_reference:\n\t\tfrappe.db.set_value(doctype, inter_company_reference, ref_field, name)\n\n\ndef unlink_inter_company_doc(doctype, name, inter_company_reference):\n\tif doctype in [\"Sales Invoice\", \"Purchase Invoice\"]:\n\t\tref_doc = \"Purchase Invoice\" if doctype == \"Sales Invoice\" else \"Sales Invoice\"\n\t\tref_field = \"inter_company_invoice_reference\"\n\telse:\n\t\tref_doc = \"Purchase Order\" if doctype == \"Sales Order\" else \"Sales Order\"\n\t\tref_field = \"inter_company_order_reference\"\n\n\tif inter_company_reference:\n\t\tfrappe.db.set_value(doctype, name, ref_field, \"\")\n\t\tfrappe.db.set_value(ref_doc, inter_company_reference, ref_field, \"\")\n\n\ndef get_list_context(context=None):\n\tfrom erpnext.controllers.website_list_for_contact import get_list_context\n\n\tlist_context = get_list_context(context)\n\tlist_context.update(\n\t\t{\n\t\t\t\"show_sidebar\": True,\n\t\t\t\"show_search\": True,\n\t\t\t\"no_breadcrumbs\": True,\n\t\t\t\"title\": _(\"Invoices\"),\n\t\t\t\"list_template\": \"templates/includes/list/list.html\",\n\t\t}\n\t)\n\treturn list_context\n\n\n@frappe.whitelist()\ndef get_bank_cash_account(mode_of_payment, company):\n\taccount = frappe.db.get_value(\n\t\t\"Mode of Payment Account\", {\"parent\": mode_of_payment, \"company\": company}, \"default_account\"\n\t)\n\tif not account:\n\t\tfrappe.throw(\n\t\t\t_(\"Please set default Cash or Bank account in Mode of Payment {0}\").format(\n\t\t\t\tget_link_to_form(\"Mode of Payment\", mode_of_payment)\n\t\t\t),\n\t\t\ttitle=_(\"Missing Account\"),\n\t\t)\n\treturn {\"account\": account}\n\n\n@frappe.whitelist()\ndef make_maintenance_schedule(source_name, target_doc=None):\n\tdoclist = get_mapped_doc(\n\t\t\"Sales Invoice\",\n\t\tsource_name,\n\t\t{\n\t\t\t\"Sales Invoice\": {\"doctype\": \"Maintenance Schedule\", \"validation\": {\"docstatus\": [\"=\", 1]}},\n\t\t\t\"Sales Invoice Item\": {\n\t\t\t\t\"doctype\": \"Maintenance Schedule Item\",\n\t\t\t},\n\t\t},\n\t\ttarget_doc,\n\t)\n\n\treturn doclist\n\n\n@frappe.whitelist()\ndef make_delivery_note(source_name, target_doc=None):\n\tdef set_missing_values(source, target):\n\t\ttarget.run_method(\"set_missing_values\")\n\t\ttarget.run_method(\"set_po_nos\")\n\t\ttarget.run_method(\"calculate_taxes_and_totals\")\n\n\tdef update_item(source_doc, target_doc, source_parent):\n\t\ttarget_doc.qty = flt(source_doc.qty) - flt(source_doc.delivered_qty)\n\t\ttarget_doc.stock_qty = target_doc.qty * flt(source_doc.conversion_factor)\n\n\t\ttarget_doc.base_amount = target_doc.qty * flt(source_doc.base_rate)\n\t\ttarget_doc.amount = target_doc.qty * flt(source_doc.rate)\n\n\tdoclist = get_mapped_doc(\n\t\t\"Sales Invoice\",\n\t\tsource_name,\n\t\t{\n\t\t\t\"Sales Invoice\": {\"doctype\": \"Delivery Note\", \"validation\": {\"docstatus\": [\"=\", 1]}},\n\t\t\t\"Sales Invoice Item\": {\n\t\t\t\t\"doctype\": \"Delivery Note Item\",\n\t\t\t\t\"field_map\": {\n\t\t\t\t\t\"name\": \"si_detail\",\n\t\t\t\t\t\"parent\": \"against_sales_invoice\",\n\t\t\t\t\t\"serial_no\": \"serial_no\",\n\t\t\t\t\t\"sales_order\": \"against_sales_order\",\n\t\t\t\t\t\"so_detail\": \"so_detail\",\n\t\t\t\t\t\"cost_center\": \"cost_center\",\n\t\t\t\t},\n\t\t\t\t\"postprocess\": update_item,\n\t\t\t\t\"condition\": lambda doc: doc.delivered_by_supplier != 1 and not doc.scio_detail,\n\t\t\t},\n\t\t\t\"Sales Taxes and Charges\": {\"doctype\": \"Sales Taxes and Charges\", \"reset_value\": True},\n\t\t\t\"Sales Team\": {\n\t\t\t\t\"doctype\": \"Sales Team\",\n\t\t\t\t\"field_map\": {\"incentives\": \"incentives\"},\n\t\t\t\t\"add_if_empty\": True,\n\t\t\t},\n\t\t},\n\t\ttarget_doc,\n\t\tset_missing_values,\n\t)\n\n\treturn doclist\n\n\n@frappe.whitelist()\ndef make_sales_return(source_name, target_doc=None):\n\tfrom erpnext.controllers.sales_and_purchase_return import make_return_doc\n\n\treturn make_return_doc(\"Sales Invoice\", source_name, target_doc)\n\n\ndef get_inter_company_details(doc, doctype):\n\tif doctype in [\"Sales Invoice\", \"Sales Order\", \"Delivery Note\"]:\n\t\tparties = frappe.db.get_all(\n\t\t\t\"Supplier\",\n\t\t\tfields=[\"name\"],\n\t\t\tfilters={\"disabled\": 0, \"is_internal_supplier\": 1, \"represents_company\": doc.company},\n\t\t)\n\t\tcompany = frappe.get_cached_value(\"Customer\", doc.customer, \"represents_company\")\n\n\t\tif not parties:\n\t\t\tfrappe.throw(\n\t\t\t\t_(\"No Supplier found for Inter Company Transactions which represents company {0}\").format(\n\t\t\t\t\tfrappe.bold(doc.company)\n\t\t\t\t)\n\t\t\t)\n\n\t\tparty = get_internal_party(parties, \"Supplier\", doc)\n\telse:\n\t\tparties = frappe.db.get_all(\n\t\t\t\"Customer\",\n\t\t\tfields=[\"name\"],\n\t\t\tfilters={\"disabled\": 0, \"is_internal_customer\": 1, \"represents_company\": doc.company},\n\t\t)\n\t\tcompany = frappe.get_cached_value(\"Supplier\", doc.supplier, \"represents_company\")\n\n\t\tif not parties:\n\t\t\tfrappe.throw(\n\t\t\t\t_(\"No Customer found for Inter Company Transactions which represents company {0}\").format(\n\t\t\t\t\tfrappe.bold(doc.company)\n\t\t\t\t)\n\t\t\t)\n\n\t\tparty = get_internal_party(parties, \"Customer\", doc)\n\n\treturn {\"party\": party, \"company\": company}\n\n\ndef get_internal_party(parties, link_doctype, doc):\n\tif len(parties) == 1:\n\t\tparty = parties[0].name\n\telse:\n\t\t# If more than one Internal Supplier/Customer, get supplier/customer on basis of address\n\t\tif doc.get(\"company_address\") or doc.get(\"shipping_address\"):\n\t\t\tparty = frappe.db.get_value(\n\t\t\t\t\"Dynamic Link\",\n\t\t\t\t{\n\t\t\t\t\t\"parent\": doc.get(\"company_address\") or doc.get(\"shipping_address\"),\n\t\t\t\t\t\"parenttype\": \"Address\",\n\t\t\t\t\t\"link_doctype\": link_doctype,\n\t\t\t\t},\n\t\t\t\t\"link_name\",\n\t\t\t)\n\n\t\t\tif not party:\n\t\t\t\tparty = parties[0].name\n\t\telse:\n\t\t\tparty = parties[0].name\n\n\treturn party\n\n\ndef validate_inter_company_transaction(doc, doctype):\n\tdetails = get_inter_company_details(doc, doctype)\n\tprice_list = (\n\t\tdoc.selling_price_list\n\t\tif doctype in [\"Sales Invoice\", \"Sales Order\", \"Delivery Note\"]\n\t\telse doc.buying_price_list\n\t)\n\tvalid_price_list = frappe.db.get_value(\"Price List\", {\"name\": price_list, \"buying\": 1, \"selling\": 1})\n\tif not valid_price_list and not doc.is_internal_transfer():\n\t\tfrappe.throw(_(\"Selected Price List should have buying and selling fields checked.\"))\n\n\tparty = details.get(\"party\")\n\tif not party:\n\t\tpartytype = \"Supplier\" if doctype in [\"Sales Invoice\", \"Sales Order\"] else \"Customer\"\n\t\tfrappe.throw(_(\"No {0} found for Inter Company Transactions.\").format(partytype))\n\n\tcompany = details.get(\"company\")\n\tdefault_currency = frappe.get_cached_value(\"Company\", company, \"default_currency\")\n\tif default_currency != doc.currency:\n\t\tfrappe.throw(\n\t\t\t_(\"Company currencies of both the companies should match for Inter Company Transactions.\")\n\t\t)\n\n\treturn\n\n\n@frappe.whitelist()\ndef make_inter_company_purchase_invoice(source_name, target_doc=None):\n\treturn make_inter_company_transaction(\"Sales Invoice\", source_name, target_doc)\n\n\n@erpnext.allow_regional\ndef make_regional_gl_entries(gl_entries, doc):\n\treturn gl_entries\n\n\ndef make_inter_company_transaction(doctype, source_name, target_doc=None):\n\tif doctype in [\"Sales Invoice\", \"Sales Order\"]:\n\t\tsource_doc = frappe.get_doc(doctype, source_name)\n\t\ttarget_doctype = \"Purchase Invoice\" if doctype == \"Sales Invoice\" else \"Purchase Order\"\n\t\ttarget_detail_field = \"sales_invoice_item\" if doctype == \"Sales Invoice\" else \"sales_order_item\"\n\t\tsource_document_warehouse_field = \"target_warehouse\"\n\t\ttarget_document_warehouse_field = \"from_warehouse\"\n\t\treceived_items = get_received_items(source_name, target_doctype, target_detail_field)\n\telse:\n\t\tsource_doc = frappe.get_doc(doctype, source_name)\n\t\ttarget_doctype = \"Sales Invoice\" if doctype == \"Purchase Invoice\" else \"Sales Order\"\n\t\tsource_document_warehouse_field = \"from_warehouse\"\n\t\ttarget_document_warehouse_field = \"target_warehouse\"\n\t\treceived_items = {}\n\n\tvalidate_inter_company_transaction(source_doc, doctype)\n\tdetails = get_inter_company_details(source_doc, doctype)\n\n\tdef set_missing_values(source, target):\n\t\ttarget.run_method(\"set_missing_values\")\n\t\tset_purchase_references(target)\n\n\tdef update_details(source_doc, target_doc, source_parent):\n\t\tdef _validate_address_link(address, link_doctype, link_name):\n\t\t\treturn frappe.db.get_value(\n\t\t\t\t\"Dynamic Link\",\n\t\t\t\t{\n\t\t\t\t\t\"parent\": address,\n\t\t\t\t\t\"parenttype\": \"Address\",\n\t\t\t\t\t\"link_doctype\": link_doctype,\n\t\t\t\t\t\"link_name\": link_name,\n\t\t\t\t},\n\t\t\t\t\"parent\",\n\t\t\t)\n\n\t\ttarget_doc.inter_company_invoice_reference = source_doc.name\n\t\tif target_doc.doctype in [\"Purchase Invoice\", \"Purchase Order\"]:\n\t\t\tcurrency = frappe.db.get_value(\"Supplier\", details.get(\"party\"), \"default_currency\")\n\t\t\ttarget_doc.company = details.get(\"company\")\n\t\t\ttarget_doc.supplier = details.get(\"party\")\n\t\t\ttarget_doc.is_internal_supplier = 1\n\t\t\ttarget_doc.ignore_pricing_rule = 1\n\t\t\ttarget_doc.buying_price_list = source_doc.selling_price_list\n\n\t\t\t# Invert Addresses\n\t\t\tif source_doc.company_address and _validate_address_link(\n\t\t\t\tsource_doc.company_address, \"Supplier\", details.get(\"party\")\n\t\t\t):\n\t\t\t\tupdate_address(target_doc, \"supplier_address\", \"address_display\", source_doc.company_address)\n\t\t\tif source_doc.dispatch_address_name and _validate_address_link(\n\t\t\t\tsource_doc.dispatch_address_name, \"Company\", details.get(\"company\")\n\t\t\t):\n\t\t\t\tupdate_address(\n\t\t\t\t\ttarget_doc,\n\t\t\t\t\t\"dispatch_address\",\n\t\t\t\t\t\"dispatch_address_display\",\n\t\t\t\t\tsource_doc.dispatch_address_name,\n\t\t\t\t)\n\t\t\tif source_doc.shipping_address_name and _validate_address_link(\n\t\t\t\tsource_doc.shipping_address_name, \"Company\", details.get(\"company\")\n\t\t\t):\n\t\t\t\tupdate_address(\n\t\t\t\t\ttarget_doc,\n\t\t\t\t\t\"shipping_address\",\n\t\t\t\t\t\"shipping_address_display\",\n\t\t\t\t\tsource_doc.shipping_address_name,\n\t\t\t\t)\n\t\t\tif source_doc.customer_address and _validate_address_link(\n\t\t\t\tsource_doc.customer_address, \"Company\", details.get(\"company\")\n\t\t\t):\n\t\t\t\tupdate_address(\n\t\t\t\t\ttarget_doc, \"billing_address\", \"billing_address_display\", source_doc.customer_address\n\t\t\t\t)\n\n\t\t\tif currency:\n\t\t\t\ttarget_doc.currency = currency\n\n\t\t\tupdate_taxes(\n\t\t\t\ttarget_doc,\n\t\t\t\tparty=target_doc.supplier,\n\t\t\t\tparty_type=\"Supplier\",\n\t\t\t\tcompany=target_doc.company,\n\t\t\t\tdoctype=target_doc.doctype,\n\t\t\t\tparty_address=target_doc.supplier_address,\n\t\t\t\tcompany_address=target_doc.shipping_address,\n\t\t\t)\n\n\t\telse:\n\t\t\tcurrency = frappe.db.get_value(\"Customer\", details.get(\"party\"), \"default_currency\")\n\t\t\ttarget_doc.company = details.get(\"company\")\n\t\t\ttarget_doc.customer = details.get(\"party\")\n\t\t\ttarget_doc.selling_price_list = source_doc.buying_price_list\n\n\t\t\tif source_doc.supplier_address and _validate_address_link(\n\t\t\t\tsource_doc.supplier_address, \"Company\", details.get(\"company\")\n\t\t\t):\n\t\t\t\tupdate_address(\n\t\t\t\t\ttarget_doc, \"company_address\", \"company_address_display\", source_doc.supplier_address\n\t\t\t\t)\n\t\t\tif source_doc.shipping_address and _validate_address_link(\n\t\t\t\tsource_doc.shipping_address, \"Customer\", details.get(\"party\")\n\t\t\t):\n\t\t\t\tupdate_address(\n\t\t\t\t\ttarget_doc, \"shipping_address_name\", \"shipping_address\", source_doc.shipping_address\n\t\t\t\t)\n\t\t\tif source_doc.shipping_address and _validate_address_link(\n\t\t\t\tsource_doc.shipping_address, \"Customer\", details.get(\"party\")\n\t\t\t):\n\t\t\t\tupdate_address(target_doc, \"customer_address\", \"address_display\", source_doc.shipping_address)\n\n\t\t\tif currency:\n\t\t\t\ttarget_doc.currency = currency\n\n\t\t\tupdate_taxes(\n\t\t\t\ttarget_doc,\n\t\t\t\tparty=target_doc.customer,\n\t\t\t\tparty_type=\"Customer\",\n\t\t\t\tcompany=target_doc.company,\n\t\t\t\tdoctype=target_doc.doctype,\n\t\t\t\tparty_address=target_doc.customer_address,\n\t\t\t\tcompany_address=target_doc.company_address,\n\t\t\t\tshipping_address_name=target_doc.shipping_address_name,\n\t\t\t)\n\n\tdef update_item(source, target, source_parent):\n\t\ttarget.qty = flt(source.qty) - received_items.get(source.name, 0.0)\n\t\tif source.doctype == \"Purchase Order Item\" and target.doctype == \"Sales Order Item\":\n\t\t\ttarget.purchase_order = source.parent\n\t\t\ttarget.purchase_order_item = source.name\n\t\t\ttarget.material_request = source.material_request\n\t\t\ttarget.material_request_item = source.material_request_item\n\n\t\tif (\n\t\t\tsource.get(\"purchase_order\")\n\t\t\tand source.get(\"purchase_order_item\")\n\t\t\tand target.doctype == \"Purchase Invoice Item\"\n\t\t):\n\t\t\ttarget.purchase_order = source.purchase_order\n\t\t\ttarget.po_detail = source.purchase_order_item\n\n\t\tif (source.get(\"serial_no\") or source.get(\"batch_no\")) and not source.get(\"serial_and_batch_bundle\"):\n\t\t\ttarget.use_serial_batch_fields = 1\n\n\titem_field_map = {\n\t\t\"doctype\": target_doctype + \" Item\",\n\t\t\"field_no_map\": [\"income_account\", \"expense_account\", \"cost_center\", \"warehouse\"],\n\t\t\"field_map\": {\n\t\t\t\"rate\": \"rate\",\n\t\t},\n\t\t\"postprocess\": update_item,\n\t\t\"condition\": lambda doc: doc.qty > 0,\n\t}\n\n\tif doctype in [\"Sales Invoice\", \"Sales Order\"]:\n\t\titem_field_map[\"field_map\"].update(\n\t\t\t{\n\t\t\t\t\"name\": target_detail_field,\n\t\t\t}\n\t\t)\n\n\tif source_doc.get(\"update_stock\"):\n\t\titem_field_map[\"field_map\"].update(\n\t\t\t{\n\t\t\t\tsource_document_warehouse_field: target_document_warehouse_field,\n\t\t\t\t\"batch_no\": \"batch_no\",\n\t\t\t\t\"serial_no\": \"serial_no\",\n\t\t\t}\n\t\t)\n\telif target_doctype == \"Sales Order\":\n\t\titem_field_map[\"field_map\"].update(\n\t\t\t{\n\t\t\t\tsource_document_warehouse_field: \"warehouse\",\n\t\t\t}\n\t\t)\n\n\tdoclist = get_mapped_doc(\n\t\tdoctype,\n\t\tsource_name,\n\t\t{\n\t\t\tdoctype: {\n\t\t\t\t\"doctype\": target_doctype,\n\t\t\t\t\"postprocess\": update_details,\n\t\t\t\t\"set_target_warehouse\": \"set_from_warehouse\",\n\t\t\t\t\"field_no_map\": [\"taxes_and_charges\", \"set_warehouse\", \"shipping_address\"],\n\t\t\t},\n\t\t\tdoctype + \" Item\": item_field_map,\n\t\t},\n\t\ttarget_doc,\n\t\tset_missing_values,\n\t)\n\n\treturn doclist\n\n\ndef get_received_items(reference_name, doctype, reference_fieldname):\n\treference_field = \"inter_company_invoice_reference\"\n\tif doctype == \"Purchase Order\":\n\t\treference_field = \"inter_company_order_reference\"\n\n\tfilters = {\n\t\treference_field: reference_name,\n\t\t\"docstatus\": 1,\n\t}\n\n\ttarget_doctypes = frappe.get_all(\n\t\tdoctype,\n\t\tfilters=filters,\n\t\tas_list=True,\n\t)\n\n\tif target_doctypes:\n\t\ttarget_doctypes = list(target_doctypes[0])\n\n\treceived_items_map = frappe._dict(\n\t\tfrappe.get_all(\n\t\t\tdoctype + \" Item\",\n\t\t\tfilters={\"parent\": (\"in\", target_doctypes)},\n\t\t\tfields=[reference_fieldname, \"qty\"],\n\t\t\tas_list=1,\n\t\t)\n\t)\n\n\treturn received_items_map\n\n\ndef set_purchase_references(doc):\n\t# add internal PO or PR links if any\n\n\tif doc.is_internal_transfer():\n\t\tif doc.doctype == \"Purchase Receipt\":\n\t\t\tso_item_map = get_delivery_note_details(doc.inter_company_invoice_reference)\n\n\t\t\tif so_item_map:\n\t\t\t\tpd_item_map, parent_child_map, warehouse_map = get_pd_details(\n\t\t\t\t\t\"Purchase Order Item\", so_item_map, \"sales_order_item\"\n\t\t\t\t)\n\n\t\t\t\tupdate_pr_items(doc, so_item_map, pd_item_map, parent_child_map, warehouse_map)\n\n\t\telif doc.doctype == \"Purchase Invoice\":\n\t\t\tdn_item_map, so_item_map = get_sales_invoice_details(doc.inter_company_invoice_reference)\n\t\t\t# First check for Purchase receipt\n\t\t\tif list(dn_item_map.values()):\n\t\t\t\tpd_item_map, parent_child_map, warehouse_map = get_pd_details(\n\t\t\t\t\t\"Purchase Receipt Item\", dn_item_map, \"delivery_note_item\"\n\t\t\t\t)\n\n\t\t\t\tupdate_pi_items(\n\t\t\t\t\tdoc,\n\t\t\t\t\t\"pr_detail\",\n\t\t\t\t\t\"purchase_receipt\",\n\t\t\t\t\tdn_item_map,\n\t\t\t\t\tpd_item_map,\n\t\t\t\t\tparent_child_map,\n\t\t\t\t\twarehouse_map,\n\t\t\t\t)\n\n\ndef update_pi_items(\n\tdoc,\n\tdetail_field,\n\tparent_field,\n\tsales_item_map,\n\tpurchase_item_map,\n\tparent_child_map,\n\twarehouse_map,\n):\n\tfor item in doc.get(\"items\"):\n\t\titem.set(detail_field, purchase_item_map.get(sales_item_map.get(item.sales_invoice_item)))\n\t\titem.set(parent_field, parent_child_map.get(sales_item_map.get(item.sales_invoice_item)))\n\t\tif doc.update_stock:\n\t\t\titem.warehouse = warehouse_map.get(sales_item_map.get(item.sales_invoice_item))\n\t\t\tif not item.warehouse and item.get(\"purchase_order\") and item.get(\"purchase_order_item\"):\n\t\t\t\titem.warehouse = frappe.db.get_value(\n\t\t\t\t\t\"Purchase Order Item\", item.purchase_order_item, \"warehouse\"\n\t\t\t\t)\n\n\ndef update_pr_items(doc, sales_item_map, purchase_item_map, parent_child_map, warehouse_map):\n\tfor item in doc.get(\"items\"):\n\t\titem.warehouse = warehouse_map.get(sales_item_map.get(item.delivery_note_item))\n\t\tif not item.warehouse and item.get(\"purchase_order\") and item.get(\"purchase_order_item\"):\n\t\t\titem.warehouse = frappe.db.get_value(\"Purchase Order Item\", item.purchase_order_item, \"warehouse\")\n\n\ndef get_delivery_note_details(internal_reference):\n\tsi_item_details = frappe.get_all(\n\t\t\"Delivery Note Item\", fields=[\"name\", \"so_detail\"], filters={\"parent\": internal_reference}\n\t)\n\n\treturn {d.name: d.so_detail for d in si_item_details if d.so_detail}\n\n\ndef get_sales_invoice_details(internal_reference):\n\tdn_item_map = {}\n\tso_item_map = {}\n\n\tsi_item_details = frappe.get_all(\n\t\t\"Sales Invoice Item\",\n\t\tfields=[\"name\", \"so_detail\", \"dn_detail\"],\n\t\tfilters={\"parent\": internal_reference},\n\t)\n\n\tfor d in si_item_details:\n\t\tif d.dn_detail:\n\t\t\tdn_item_map.setdefault(d.name, d.dn_detail)\n\t\tif d.so_detail:\n\t\t\tso_item_map.setdefault(d.name, d.so_detail)\n\n\treturn dn_item_map, so_item_map\n\n\ndef get_pd_details(doctype, sd_detail_map, sd_detail_field):\n\tpd_item_map = {}\n\taccepted_warehouse_map = {}\n\tparent_child_map = {}\n\n\tpd_item_details = frappe.get_all(\n\t\tdoctype,\n\t\tfields=[sd_detail_field, \"name\", \"warehouse\", \"parent\"],\n\t\tfilters={sd_detail_field: (\"in\", list(sd_detail_map.values()))},\n\t)\n\n\tfor d in pd_item_details:\n\t\tpd_item_map.setdefault(d.get(sd_detail_field), d.name)\n\t\tparent_child_map.setdefault(d.get(sd_detail_field), d.parent)\n\t\taccepted_warehouse_map.setdefault(d.get(sd_detail_field), d.warehouse)\n\n\treturn pd_item_map, parent_child_map, accepted_warehouse_map\n\n\ndef update_taxes(\n\tdoc,\n\tparty=None,\n\tparty_type=None,\n\tcompany=None,\n\tdoctype=None,\n\tparty_address=None,\n\tcompany_address=None,\n\tshipping_address_name=None,\n\tmaster_doctype=None,\n):\n\t# Update Party Details\n\tparty_details = get_party_details(\n\t\tparty=party,\n\t\tparty_type=party_type,\n\t\tcompany=company,\n\t\tdoctype=doctype,\n\t\tparty_address=party_address,\n\t\tcompany_address=company_address,\n\t\tshipping_address=shipping_address_name,\n\t)\n\n\t# Update taxes and charges if any\n\tdoc.taxes_and_charges = party_details.get(\"taxes_and_charges\")\n\tdoc.set(\"taxes\", party_details.get(\"taxes\"))\n\n\ndef update_address(doc, address_field, address_display_field, address_name):\n\tdoc.set(address_field, address_name)\n\tfetch_values = get_fetch_values(doc.doctype, address_field, address_name)\n\n\tfor key, value in fetch_values.items():\n\t\tdoc.set(key, value)\n\n\tdoc.set(address_display_field, get_address_display(doc.get(address_field)))\n\n\n@frappe.whitelist()\ndef get_loyalty_programs(customer):\n\t\"\"\"sets applicable loyalty program to the customer or returns a list of applicable programs\"\"\"\n\tfrom erpnext.selling.doctype.customer.customer import get_loyalty_programs\n\n\tcustomer = frappe.get_doc(\"Customer\", customer)\n\tif customer.loyalty_program:\n\t\treturn [customer.loyalty_program]\n\n\tlp_details = get_loyalty_programs(customer)\n\n\tif len(lp_details) == 1:\n\t\tcustomer.db_set(\"loyalty_program\", lp_details[0])\n\t\treturn lp_details\n\telse:\n\t\treturn lp_details\n\n\n@frappe.whitelist()\ndef create_invoice_discounting(source_name, target_doc=None):\n\tinvoice = frappe.get_doc(\"Sales Invoice\", source_name)\n\tinvoice_discounting = frappe.new_doc(\"Invoice Discounting\")\n\tinvoice_discounting.company = invoice.company\n\tinvoice_discounting.append(\n\t\t\"invoices\",\n\t\t{\n\t\t\t\"sales_invoice\": source_name,\n\t\t\t\"customer\": invoice.customer,\n\t\t\t\"posting_date\": invoice.posting_date,\n\t\t\t\"outstanding_amount\": invoice.outstanding_amount,\n\t\t},\n\t)\n\n\treturn invoice_discounting\n\n\ndef update_multi_mode_option(doc, pos_profile):\n\tdef append_payment(payment_mode):\n\t\tpayment = doc.append(\"payments\", {})\n\t\tpayment.default = payment_mode.default\n\t\tpayment.mode_of_payment = payment_mode.mop\n\t\tpayment.account = payment_mode.default_account\n\t\tpayment.type = payment_mode.type\n\n\tdoc.set(\"payments\", [])\n\tinvalid_modes = []\n\tmode_of_payments = [d.mode_of_payment for d in pos_profile.get(\"payments\")]\n\tmode_of_payments_info = get_mode_of_payments_info(mode_of_payments, doc.company)\n\n\tfor row in pos_profile.get(\"payments\"):\n\t\tpayment_mode = mode_of_payments_info.get(row.mode_of_payment)\n\t\tif not payment_mode:\n\t\t\tinvalid_modes.append(get_link_to_form(\"Mode of Payment\", row.mode_of_payment))\n\t\t\tcontinue\n\n\t\tpayment_mode.default = row.default\n\t\tappend_payment(payment_mode)\n\n\tif invalid_modes:\n\t\tif invalid_modes == 1:\n\t\t\tmsg = _(\"Please set default Cash or Bank account in Mode of Payment {}\")\n\t\telse:\n\t\t\tmsg = _(\"Please set default Cash or Bank account in Mode of Payments {}\")\n\t\tfrappe.throw(msg.format(\", \".join(invalid_modes)), title=_(\"Missing Account\"))\n\n\ndef get_all_mode_of_payments(doc):\n\treturn frappe.db.sql(\n\t\t\"\"\"\n\t\tselect mpa.default_account, mpa.parent, mp.type as type\n\t\tfrom `tabMode of Payment Account` mpa,`tabMode of Payment` mp\n\t\twhere mpa.parent = mp.name and mpa.company = %(company)s and mp.enabled = 1\"\"\",\n\t\t{\"company\": doc.company},\n\t\tas_dict=1,\n\t)\n\n\ndef get_mode_of_payments_info(mode_of_payments, company):\n\tdata = frappe.db.sql(\n\t\t\"\"\"\n\t\tselect\n\t\t\tmpa.default_account, mpa.parent as mop, mp.type as type\n\t\tfrom\n\t\t\t`tabMode of Payment Account` mpa,`tabMode of Payment` mp\n\t\twhere\n\t\t\tmpa.parent = mp.name and\n\t\t\tmpa.company = %s and\n\t\t\tmp.enabled = 1 and\n\t\t\tmp.name in %s\n\t\tgroup by\n\t\t\tmp.name\n\t\t\"\"\",\n\t\t(company, mode_of_payments),\n\t\tas_dict=1,\n\t)\n\n\treturn {row.get(\"mop\"): row for row in data}\n\n\ndef get_mode_of_payment_info(mode_of_payment, company):\n\treturn frappe.db.sql(\n\t\t\"\"\"\n\t\tselect mpa.default_account, mpa.parent, mp.type as type\n\t\tfrom `tabMode of Payment Account` mpa,`tabMode of Payment` mp\n\t\twhere mpa.parent = mp.name and mpa.company = %s and mp.enabled = 1 and mp.name = %s\"\"\",\n\t\t(company, mode_of_payment),\n\t\tas_dict=1,\n\t)\n\n\n@frappe.whitelist()\ndef create_dunning(source_name, target_doc=None, ignore_permissions=False):\n\tfrom frappe.model.mapper import get_mapped_doc\n\n\tdef postprocess_dunning(source, target):\n\t\tfrom erpnext.accounts.doctype.dunning.dunning import get_dunning_letter_text\n\n\t\tdunning_type = frappe.db.exists(\"Dunning Type\", {\"is_default\": 1, \"company\": source.company})\n\t\tif dunning_type:\n\t\t\tdunning_type = frappe.get_doc(\"Dunning Type\", dunning_type)\n\t\t\ttarget.dunning_type = dunning_type.name\n\t\t\ttarget.rate_of_interest = dunning_type.rate_of_interest\n\t\t\ttarget.dunning_fee = dunning_type.dunning_fee\n\t\t\ttarget.income_account = dunning_type.income_account\n\t\t\ttarget.cost_center = dunning_type.cost_center\n\t\t\tletter_text = get_dunning_letter_text(\n\t\t\t\tdunning_type=dunning_type.name, doc=target.as_dict(), language=source.language\n\t\t\t)\n\n\t\t\tif letter_text:\n\t\t\t\ttarget.body_text = letter_text.get(\"body_text\")\n\t\t\t\ttarget.closing_text = letter_text.get(\"closing_text\")\n\t\t\t\ttarget.language = letter_text.get(\"language\")\n\n\t\t# update outstanding from doc\n\t\tif source.payment_schedule and len(source.payment_schedule) == 1:\n\t\t\tfor row in target.overdue_payments:\n\t\t\t\tif row.payment_schedule == source.payment_schedule[0].name:\n\t\t\t\t\trow.outstanding = source.get(\"outstanding_amount\")\n\n\t\ttarget.validate()\n\n\treturn get_mapped_doc(\n\t\tfrom_doctype=\"Sales Invoice\",\n\t\tfrom_docname=source_name,\n\t\ttarget_doc=target_doc,\n\t\ttable_maps={\n\t\t\t\"Sales Invoice\": {\n\t\t\t\t\"doctype\": \"Dunning\",\n\t\t\t\t\"field_map\": {\"customer_address\": \"customer_address\", \"parent\": \"sales_invoice\"},\n\t\t\t},\n\t\t\t\"Payment Schedule\": {\n\t\t\t\t\"doctype\": \"Overdue Payment\",\n\t\t\t\t\"field_map\": {\"name\": \"payment_schedule\", \"parent\": \"sales_invoice\"},\n\t\t\t\t\"condition\": lambda doc: doc.outstanding > 0 and getdate(doc.due_date) < getdate(),\n\t\t\t},\n\t\t},\n\t\tpostprocess=postprocess_dunning,\n\t\tignore_permissions=ignore_permissions,\n\t)\n\n\ndef check_if_return_invoice_linked_with_payment_entry(self):\n\t# If a Return invoice is linked with payment entry along with other invoices,\n\t# the cancellation of the Return causes allocated amount to be greater than paid\n\n\tif not frappe.get_single_value(\"Accounts Settings\", \"unlink_payment_on_cancellation_of_invoice\"):\n\t\treturn\n\n\tpayment_entries = []\n\tif self.is_return and self.return_against:\n\t\tinvoice = self.return_against\n\telse:\n\t\tinvoice = self.name\n\n\tpayment_entries = frappe.db.sql_list(\n\t\t\"\"\"\n\t\tSELECT\n\t\t\tt1.name\n\t\tFROM\n\t\t\t`tabPayment Entry` t1, `tabPayment Entry Reference` t2\n\t\tWHERE\n\t\t\tt1.name = t2.parent\n\t\t\tand t1.docstatus = 1\n\t\t\tand t2.reference_name = %s\n\t\t\tand t2.allocated_amount < 0\n\t\t\"\"\",\n\t\tinvoice,\n\t)\n\n\tlinks_to_pe = []\n\tif payment_entries:\n\t\tfor payment in payment_entries:\n\t\t\tpayment_entry = frappe.get_doc(\"Payment Entry\", payment)\n\t\t\tif len(payment_entry.references) > 1:\n\t\t\t\tlinks_to_pe.append(payment_entry.name)\n\t\tif links_to_pe:\n\t\t\tpayment_entries_link = [\n\t\t\t\tget_link_to_form(\"Payment Entry\", name, label=name) for name in links_to_pe\n\t\t\t]\n\t\t\tmessage = _(\"Please cancel and amend the Payment Entry\")\n\t\t\tmessage += \" \" + \", \".join(payment_entries_link) + \" \"\n\t\t\tmessage += _(\"to unallocate the amount of this Return Invoice before cancelling it.\")\n\t\t\tfrappe.throw(message)\n"
}